<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    
    <!-- SEO Meta Tags -->
    <title>Twittex - Gofile ランキング・Twitter Video まとめサイト</title>
    <meta name="description" content="Twittex は Gofile のリアルタイムランキング、Twitter Video、安全なURL まとめサイト。人気ファイルをランキング表示・リアルタイム鑑賞できます。">
    <meta name="keywords" content="gofile,gofileランキング,gofileリアルタイムランキング,gofile url,Twitter video,動画まとめ,URL共有,リアルタイム,鑑賞">
    <meta name="author" content="Twittex">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Japanese">
    
    <!-- Open Graph (OG) Tags for Social Media Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Twittex - Gofile・Twitter Video ランキングサイト">
    <meta property="og:description" content="Gofile のリアルタイムランキングと Twitter Video・安全なURL をまとめたサイト。みんなで一緒に鑑賞できます。">
    <meta property="og:url" content="https://twittex.space">
    <meta property="og:site_name" content="Twittex">
    <meta property="og:image" content="https://twittex.space/images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Twittex - Gofile ランキング・URL まとめ">
    <meta name="twitter:description" content="Gofile・Twitter Video の最新ランキングと人気URL をまとめたサイト。リアルタイムで一緒に楽しめます。">
    <meta name="twitter:image" content="https://twittex.space/images/twitter-image.png">
    <meta name="twitter:creator" content="@twittex">
    <meta name="twitter:site" content="@twittex">
    
    <!-- Additional Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PulseNote">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://twittex.space">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    
    <!-- Pop-Under Advertisement -->
    <script src="https://engagementidentifiers.com/14/29/79/142979e47a62210d83ef5275ac4060ca.js"></script>
    
    <!-- Pop-Under Advertisement -->
    <script src="https://engagementidentifiers.com/14/29/79/142979e47a62210d83ef5275ac4060ca.js"></script>
</head>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #1d9bf0;
            --bg-primary: #000000;
            --bg-secondary: #16191c;
            --text-primary: #ffffff;
            --text-secondary: #71767b;
            --border: #2f3336;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            display: flex;
        }

        .sidebar {
            width: 280px;
            height: 100vh;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
            overflow-y: auto;
            position: static;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.drawer-open {
            transform: translateX(0);
        }

        .sidebar.drawer-closed {
            /* モバイルのみに移動 */
        }

        .sidebar-toggle {
            display: none !important;
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 999;
            background: var(--primary);
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(29, 155, 240, 0.3);
            transition: all 0.3s;
        }

        .sidebar-toggle:active {
            transform: scale(0.95);
            box-shadow: 0 4px 12px rgba(29, 155, 240, 0.4);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
                position: static;
            }

            .sidebar.drawer-closed {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 280px;
                height: 100vh;
                position: fixed;
                left: 0;
                top: 0;
                transform: translateX(-100%);
            }

            .sidebar.drawer-open {
                transform: translateX(0);
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            }

            .sidebar.drawer-closed {
                transform: translateX(-100%);
            }

            .sidebar-toggle {
                display: flex;
            }

            .main-container {
                margin-left: 0 !important;
            }

            .app-container {
                display: flex;
                position: relative;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        .sidebar-logo {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .sidebar-logo:hover {
            background-color: rgba(29, 155, 240, 0.1);
        }

        .sidebar-logo img {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 20px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            transition: background-color 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            -webkit-appearance: none;
            appearance: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item:active {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-item.active {
            background: rgba(29, 155, 240, 0.2);
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .nav-item {
                min-height: 48px;
                padding: 12px 12px;
                font-size: 14px;
            }
        }

        .nav-section-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 8px;
        }

        .gsh-nav-item, .notification-nav-item, .youtube-btn, .qa-btn {
            padding: 12px 16px;
            border-radius: 20px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            transition: background-color 0.2s;
            position: relative;
        }

        .gsh-nav-item:hover, .notification-nav-item:hover, .youtube-btn:hover, .qa-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge-nav {
            position: absolute;
            top: 8px;
            right: 12px;
            background: #e0245e;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }

        .sidebar-account {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .account-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            cursor: pointer;
        }

        .account-info {
            flex: 1;
            min-width: 0;
        }

        .account-name {
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .account-id {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: #e0245e;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.8);

            position: sticky;
            top: 0;
            z-index: 50;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gsh-logo-header {
            width: 32px;
            height: 32px;
            object-fit: contain;
            display: none;
        }

        .gsh-logo-header.visible {
            display: block;
        }

        .top-bar-title {
            font-size: 20px;
            font-weight: 700;
        }

        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
            gap: 16px;
            padding: 16px;
        }

        .feed-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        #feed {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        @media (max-width: 768px) {
            #feed {
                padding-bottom: 120px;
            }
        }

        #feed::-webkit-scrollbar {
            width: 8px;
        }

        #feed::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .post-card {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .post-card:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .post-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #00d9ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .post-info {
            flex: 1;
        }

        .post-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .post-name {
            font-weight: 700;
            font-size: 15px;
        }

        .post-id {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .post-time {
            color: var(--text-secondary);
            font-size: 15px;
            margin-left: auto;
        }

        .post-content {
            margin-top: 8px;
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .post-actions {
            display: flex;
            justify-content: space-around;
            color: var(--text-secondary);
            font-size: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
            justify-content: center;
            font-size: 12px;
        }

        .action-item:hover {
            color: var(--primary);
        }

        .trend-section {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .trend-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .trend-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            font-size: 15px;
        }

        .trend-content {
            padding: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .trend-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .trend-item:hover {
            background-color: rgba(29, 155, 240, 0.1);
        }

        .trend-item:last-child {
            border-bottom: none;
        }

        .trend-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .trend-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .trend-count {
            font-weight: 700;
            color: var(--primary);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Q&A モーダル */
        .qa-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 999;
            flex-direction: column;
        }

        .qa-modal.open {
            display: flex;
        }

        .qa-modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);

        }

        .qa-modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .qa-modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .qa-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .qa-item {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        .qa-item:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        .qa-question {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .qa-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            align-items: center;
        }

        .qa-category {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .qa-stats {
            display: flex;
            gap: 8px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Q&A詳細モーダル */
        .qa-detail-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 1000;
            flex-direction: column;
        }

        .qa-detail-modal.open {
            display: flex;
        }

        .qa-detail-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);

        }

        .qa-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .qa-detail-question {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .qa-detail-question-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .qa-detail-question-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .qa-answers-section {
            margin-bottom: 12px;
        }

        .qa-answers-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .qa-answer-item {
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .qa-answer-text {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 6px;
        }

        .qa-answer-meta {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Q&A詳細モーダル用の入力エリア */
        .qa-detail-modal .qa-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.8);

            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            width: 100%;
            max-width: none;
            margin: 0;
        }

        .qa-detail-modal .qa-input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            align-self: flex-start;
            width: 100%;
        }

        .qa-detail-modal .qa-textarea {
            width: 100%;
            max-width: 600px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            font-family: inherit;
            height: 80px !important;
        }

        .qa-detail-modal .qa-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .qa-detail-modal .qa-submit-btn {
            padding: 10px 28px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
            height: 42px;
            width: auto;
            min-width: 100px;
        }

        .qa-detail-modal .qa-submit-btn:hover {
            opacity: 0.9;
        }

        .qa-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.8);

            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .qa-input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            align-self: flex-start;
            width: 100%;
        }

        .qa-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            font-family: inherit;
            height: 80px !important;
        }

        .qa-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .qa-submit-btn {
            padding: 10px 28px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
            height: 42px;
            width: auto;
            min-width: 100px;
        }

        .qa-submit-btn:hover {
            opacity: 0.9;
        }

        #qaCategory {
            width: 100%;
            padding: 10px !important;
            height: 42px !important;
            font-size: 13px !important;
            border-radius: 6px !important;
        }

        /* 通知モーダル */
        .notification-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 999;
            flex-direction: column;
        }

        .notification-modal.open {
            display: flex;
        }

        .notification-modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);

        }

        .notification-modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .notification-modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .notification-modal-content {
            flex: 1;
            overflow-y: auto;
        }

        .notification-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .notification-modal-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        .notification-item-name {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
        }

        .notification-item-title {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .notification-item-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }

        .notification-item-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* 検索モーダル */
        .search-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 999;
            flex-direction: column;
        }

        .search-modal.open {
            display: flex;
        }

        .search-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);

        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-result-item {
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        .search-result-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .search-result-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .ai-modal, .youtube-setup-modal, .youtube-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 999;
            flex-direction: column;
        }

        .ai-modal.open, .youtube-setup-modal.open, .youtube-modal.open {
            display: flex;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);

        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-logo {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-welcome {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .ai-welcome-text {
            font-size: 24px;
            font-weight: 500;
            line-height: 1.8;
            color: var(--text-secondary);
            max-width: 500px;
        }

        .ai-message {
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.4;
            max-width: 80%;
        }

        .ai-message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
        }

        .ai-message.assistant {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            align-self: flex-start;
            max-width: 90%;
        }

        .input-area {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(0, 0, 0, 0.8);

        }

        .input-field {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text-primary);
            font-size: 15px;
            min-height: 44px;
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 100%;
            padding: 12px 24px;
            background: var(--primary);
            border: none;
            border-radius: 24px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            font-size: 15px;
            font-weight: 600;
            min-height: 44px;
        }

        .send-btn:hover {
            opacity: 0.8;
        }

        .youtube-setup-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .youtube-setup-info {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            max-width: 500px;
        }

        .youtube-setup-link {
            padding: 12px 24px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 16px;
            transition: opacity 0.2s;
        }

        .youtube-setup-link:hover {
            opacity: 0.9;
        }

        .url-display {
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
            width: 100%;
            max-width: 400px;
        }

        .url-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .url-box {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .url-text {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--primary);
            font-size: 12px;
            word-break: break-all;
            overflow-y: auto;
            max-height: 80px;
        }

        .url-copy-btn {
            padding: 8px 12px;
            background: var(--primary);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .url-copy-btn:hover {
            opacity: 0.9;
        }

        .youtube-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            gap: 16px;
            padding: 16px;
        }

        .youtube-player {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .youtube-iframe {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .youtube-sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .queue-panel, .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            font-size: 14px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .queue-item {
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            border-left: 3px solid var(--primary);
        }

        .queue-item.playing {
            border-left-color: #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }

        .queue-item-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .queue-item-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
        }

        .chat-message-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 11px;
        }

        .chat-message-text {
            color: var(--text-primary);
        }

        .panel-input {
            padding: 8px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 6px;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        .modal.open {
            display: flex;
        }

        @media (max-width: 768px) {
            .modal {
                padding: 0;
                align-items: stretch;
            }
        }

        .modal-dialog {
            width: 100%;
            max-width: 600px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .modal-dialog {
                max-width: 100%;
                border-radius: 12px;
                max-height: 95vh;
            }
        }

        .modal-dialog-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-dialog-close {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-dialog-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .modal-dialog-body {
                padding: 12px;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-box {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .submit-btn {
            width: 100%;
            padding: 14px 16px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.2s;
            min-height: 44px;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .submit-btn:active {
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .submit-btn {
                min-height: 48px;
                font-size: 16px;
                padding: 16px 12px;
            }
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            z-index: 2000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* 投稿作成モーダル */
        .compose-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: flex-start;
            justify-content: center;
            padding-top: 40px;
        }

        .compose-modal.open {
            display: flex;
        }

        .compose-dialog {
            width: 100%;
            max-width: 600px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .compose-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compose-close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .compose-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .compose-header-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .compose-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #00d9ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .compose-info {
            flex: 1;
        }

        .compose-name {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
        }

        .compose-id {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .compose-url-input {
            display: none;
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .compose-url-input.active {
            display: block;
        }

        .compose-url-input::placeholder {
            color: var(--text-secondary);
        }

        .compose-url-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .compose-textarea {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            resize: none;
            font-family: inherit;
            flex: 1;
            min-height: 120px;
            outline: none;
        }

        .compose-textarea::placeholder {
            color: var(--text-secondary);
        }

        .compose-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 0;
            border-top: 1px solid var(--border);
            color: var(--primary);
            font-size: 18px;
        }

        .compose-toolbar-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
            font-size: 16px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compose-toolbar-btn:hover {
            background-color: rgba(29, 155, 240, 0.1);
        }

        .compose-toolbar-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .compose-media-preview {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .compose-image-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .compose-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .compose-image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .compose-image-remove:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .compose-url-preview {
            margin-top: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
        }

        .compose-url-preview-card {
            display: flex;
            gap: 12px;
            cursor: pointer;
        }

        .compose-url-preview-image {
            width: 120px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        .compose-url-preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .compose-url-preview-content {
            flex: 1;
            min-width: 0;
        }

        .compose-url-preview-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .compose-url-preview-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .compose-url-preview-domain {
            font-size: 11px;
            color: var(--primary);
        }

        .compose-url-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .compose-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 10;
        }

        .compose-reply-option {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-size: 14px;
        }

        .compose-reply-option button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .compose-reply-option button:hover {
            background-color: rgba(29, 155, 240, 0.1);
        }

        .compose-post-btn {
            padding: 10px 24px;
            background: var(--primary);
            border: none;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 80px;
        }

        .compose-post-btn:hover {
            opacity: 0.9;
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(29, 155, 240, 0.3);
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(29, 155, 240, 0.4);
        }

        .fab:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .fab {
                bottom: 100px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 24px;
                z-index: 98;
            }
        }

        /* Bottom Navigation for Mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            z-index: 500;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 20%;
            height: 100%;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
            -webkit-appearance: none;
            appearance: none;
            padding: 0;
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .bottom-nav-item:active {
            opacity: 0.7;
        }

        .bottom-nav-item.active svg {
            stroke: var(--primary);
            color: var(--primary);
        }

        @media (max-width: 1400px) {
            .trend-section {
                display: none;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                margin-left: 0 !important;
                padding-bottom: 160px;
            }

            .bottom-nav {
                display: flex;
            }

            .youtube-content {
                flex-direction: column;
            }

            .youtube-sidebar {
                width: 100%;
                height: 200px;
            }

            .modal-dialog {
                border-radius: 12px 12px 0 0;
            }

            /* Gsh AI Modal Mobile Responsive */
            .ai-modal {
                inset: 0;
                padding-bottom: 60px;
            }

            .ai-modal > div {
                height: calc(100vh - 60px);
                max-height: none;
            }

            .ai-messages {
                padding: 12px;
                font-size: 13px;
            }

            .ai-welcome-text {
                font-size: 18px;
                padding: 20px;
                max-width: 100%;
            }

            .ai-message {
                max-width: 85%;
                padding: 8px 10px;
                font-size: 12px;
            }

            .ai-message.assistant {
                max-width: 85%;
            }

            .input-area {
                padding: 12px;
                gap: 8px;
                flex-direction: row;
            }

            .input-field {
                flex: 1;
                padding: 10px 12px;
                font-size: 14px;
            }

            .send-btn {
                padding: 10px 16px;
                min-height: 40px;
                font-size: 14px;
                white-space: nowrap;
            }

            .modal-header {
                padding: 12px 16px;
            }

            .modal-title {
                font-size: 16px;
            }

            .modal-close-btn {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button (Mobile Only) -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>

    <!-- Sidebar Overlay (Mobile Only) -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <img src="images/logo.png" alt="PulseNote">
        </div>

        <div class="sidebar-nav">
            <button class="nav-item active" onclick="switchTab('feed'); closeSidebar();" data-translate="home">Home</button>
            <button class="nav-item" onclick="openSearchModal(); closeSidebar();" data-translate="search">Search</button>
        </div>

        <div class="nav-section-divider"></div>

        <div class="nav-section">
            <button class="gsh-nav-item" onclick="closeCommentsModal(); closeDMModal(); openAIModal(); closeSidebar();" data-translate="gsh">Gsh</button>
            <button class="qa-btn" onclick="closeCommentsModal(); closeDMModal(); openDMModal(); closeSidebar();">Messages</button>
            <button class="qa-btn" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); openQAModal(); closeSidebar();" data-translate="qa">Q&A</button>
            <button class="notification-nav-item" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); openNotificationModal(); closeSidebar();">
                <span data-translate="notifications">Notifications</span>
                <div class="notification-badge-nav" id="notificationBadgeNav" style="display: none;">0</div>
            </button>
            <button class="youtube-btn" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); openURLViewerModal()" data-translate="watchURL">Watch URL</button>
        </div>

        <div class="sidebar-account">
            <div class="account-avatar" id="accountAvatar">U</div>
            <div class="account-info" style="flex: 1;">
                <div class="account-name" id="accountName">User</div>
                <div class="account-id" id="accountId">#0000000</div>
            </div>
        </div>
        
        <div style="padding: 12px; border-top: 1px solid var(--border);">
            <button class="logout-btn" onclick="confirmLogout()" data-translate="exit" style="width: 100%; padding: 8px 12px; cursor: pointer;">Exit</button>
        </div>
    </div>

    <div class="main-container">
        <div class="top-bar">
            <div class="top-bar-left">
                <img src="images/gsh.png" alt="Gsh" class="gsh-logo-header" id="gshLogoHeader">
                <div class="top-bar-title" id="tabTitle" data-translate="home">Home</div>
            </div>
        </div>

        <div class="content">
            <div class="feed-section">
                <div id="feed"></div>
            </div>

            <!-- トレンドセクション -->
            <div class="trend-section">
                <div class="trend-panel">
                    <div class="trend-header">Trending Posts (Top 10)</div>
                    
                    <!-- 時間範囲選択ボタン -->
                    <div style="display: flex; gap: 6px; padding: 8px 12px; border-bottom: 1px solid var(--border); overflow-x: auto;">
                        <button onclick="setTrendingTimeRange(24)" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">24h</button>
                        <button onclick="setTrendingTimeRange(24)" style="padding: 6px 12px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">1 Day</button>
                        <button onclick="setTrendingTimeRange(168)" style="padding: 6px 12px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">1 Week</button>
                    </div>
                    
                    <div class="trend-content" id="trendingPosts"></div>
                </div>

                <div class="trend-panel">
                    <div class="trend-header">Popular URL Rooms - Gofile / Twitter Video</div>
                    <div class="trend-content" id="trendingYouTube"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Q&Aモーダル -->
    <div id="qaModal" class="qa-modal" onclick="if(event.target === this) closeQAModal()" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 900px; height: 90vh; max-height: 700px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="qa-modal-header">
                <div class="qa-modal-title" data-translate="qa">Q&A</div>
                <button class="qa-modal-close" onclick="closeQAModal()">X</button>
            </div>
            <div class="qa-modal-content" id="qaModalContent" style="flex: 1; overflow-y: auto;"></div>
            <div class="qa-input-area">
                <div class="qa-input-label" data-translate="askQuestion">Ask a Question</div>
                <textarea id="qaQuestionInput" class="qa-textarea" placeholder="What do you want to ask?" maxlength="500"></textarea>
                <select id="qaCategory" style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 12px; height: 36px;">
                    <option value="general">General</option>
                    <option value="tech">Technology</option>
                    <option value="health">Health</option>
                    <option value="lifestyle">Lifestyle</option>
                    <option value="other">Other</option>
                </select>
                <button class="qa-submit-btn" onclick="submitQuestion()" data-translate="ask">Ask</button>
            </div>
        </div>
    </div>

    <!-- Q&A詳細モーダル -->
    <div id="qaDetailModal" class="qa-detail-modal" onclick="if(event.target === this) closeQADetailModal()">
        <div class="qa-detail-header">
            <div style="font-size: 20px; font-weight: 700;" data-translate="questionDetails">Question Details</div>
            <button class="modal-close-btn" onclick="closeQADetailModal()">X</button>
        </div>
        <div class="qa-detail-content" id="qaDetailContent"></div>
        <div class="qa-input-area">
            <div class="qa-input-label" data-translate="yourAnswer">Your Answer</div>
            <textarea id="qaAnswerInput" class="qa-textarea" placeholder="Write your answer..." maxlength="1000"></textarea>
            <button class="qa-submit-btn" onclick="submitAnswer()" data-translate="answer">Answer</button>
        </div>
    </div>

    <!-- 通知モーダル -->
    <div id="notificationModal" class="notification-modal" onclick="if(event.target === this) closeNotificationModal()" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 600px; height: 90vh; max-height: 500px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="notification-modal-header">
                <div class="notification-modal-title" data-translate="notifications">Notifications</div>
                <button class="notification-modal-close" onclick="closeNotificationModal()">X</button>
            </div>
            <div class="notification-modal-content" id="notificationModalContent" style="flex: 1; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- 検索モーダル -->
    <div id="searchModal" class="search-modal" onclick="if(event.target === this) closeSearchModal()" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 900px; height: 90vh; max-height: 700px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="search-header">
                <input type="text" id="searchInput" class="search-input" placeholder="Search posts, users..." onkeyup="performSearch()">
                <button class="search-close" onclick="closeSearchModal()">X</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="ai-modal" onclick="if(event.target === this) closeAIModal()" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 800px; height: 90vh; max-height: 600px; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <img src="images/gsh.png" alt="Gsh" class="modal-logo">
                    <div class="modal-title" data-translate="gshAI">Gsh AI</div>
                </div>
                <button class="modal-close-btn" onclick="closeAIModal()">X</button>
            </div>
            
            <!-- メッセージ表示 -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div id="aiMessages" class="ai-messages">
                    <div class="ai-welcome">
                        <div class="ai-welcome-text" id="welcomeMessage"></div>
                    </div>
                </div>
                <div class="input-area">
                    <input type="text" id="aiInput" class="input-field" placeholder="Ask Gsh anything..." onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button class="send-btn" onclick="sendAIMessage()" data-translate="send">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Setup Modal -->
    <div id="youtubeSetupModal" class="youtube-setup-modal" onclick="if(event.target === this) closeYouTubeSetupModal()">
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; width: 100%;">
            <div class="modal-header">
                <div class="modal-title" data-translate="watchURL">Watch URL - Gofile / Twitter Video</div>
                <button class="modal-close-btn" onclick="closeYouTubeSetupModal()">X</button>
            </div>
            <div class="youtube-setup-content">
                <div style="font-size: 48px; margin-bottom: 24px;">▶</div>
                <h2 style="font-size: 24px; margin-bottom: 12px;">Create Your Room</h2>
                <div class="youtube-setup-info">
                    Start a URL room to watch with friends and share your favorite URLs - Gofile, Twitter Video, safe websites
                </div>
                <button class="youtube-setup-link" onclick="openYouTubeCreateModal()">Create New Room</button>

                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">OR</div>

                <h3 style="font-size: 16px; margin-bottom: 12px;">Join Existing Room</h3>
                <div class="url-display">
                    <div class="url-label">Paste Room URL or ID:</div>
                    <div class="url-box">
                        <input type="text" id="joinRoomInput" class="input-field" placeholder="e.g., yt_1234567890" style="flex: 1;">
                        <button class="url-copy-btn" onclick="joinRoom()">Join</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Create Room Modal -->
    <div id="youtubeCreateModal" class="modal" onclick="if(event.target === this) closeYouTubeCreateModal()">
        <div class="modal-dialog">
            <div class="modal-dialog-header">
                <div data-translate="createRoom">Create Room</div>
                <button class="modal-dialog-close" onclick="closeYouTubeCreateModal()">X</button>
            </div>
            <div class="modal-dialog-body">
                <div class="input-group">
                    <div class="input-label" data-translate="roomTitle">Room Title</div>
                    <input type="text" id="youtubeTitle" class="input-box" placeholder="Enter room title" maxlength="100">
                </div>
                <div class="input-group">
                    <div class="input-label" data-translate="youtubeVideoId">YouTube Video ID</div>
                    <input type="text" id="youtubeVideoId" class="input-box" placeholder="e.g., dQw4w9WgXcQ">
                </div>
                <button class="submit-btn" onclick="createYouTubeRoom()" data-translate="createRoomBtn">Create Room</button>
            </div>
        </div>
    </div>

    <!-- YouTube Watch Modal -->
    <div id="youtubeWatchModal" class="youtube-modal" onclick="if(event.target === this) closeYouTubeWatchModal()">
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; width: 100%;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                    <div class="modal-title" id="youtubeRoomTitle">YouTube Room</div>
                    <div class="url-display" style="margin: 0; flex: 1; max-width: 400px;">
                        <div class="url-label">Room URL:</div>
                        <div class="url-box">
                            <input type="text" id="roomUrlDisplay" class="input-field" readonly style="flex: 1; cursor: pointer;">
                            <button class="url-copy-btn" onclick="copyRoomUrl()">Copy</button>
                        </div>
                    </div>
                </div>
                <button class="modal-close-btn" onclick="leaveYouTubeRoom()" style="background: #e0245e; border-radius: 6px; padding: 8px 16px; color: white; font-size: 13px; font-weight: 700; margin-right: 8px;">Leave</button>
                <button class="modal-close-btn" onclick="closeYouTubeWatchModal()">X</button>
            </div>
            <div class="youtube-content">
                <div class="youtube-player">
                    <iframe id="youtubePlayer" class="youtube-iframe" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowFullScreen frameborder="0"></iframe>
                </div>
                <div class="youtube-sidebar">
                    <div class="queue-panel">
                        <div class="panel-header" data-translate="queue">Queue</div>
                        <div class="panel-content" id="queueList"></div>
                        <button class="submit-btn" style="margin: 8px;" onclick="openAddVideoModal()">+ Add Video</button>
                    </div>
                    <div class="chat-panel">
                        <div class="panel-header" data-translate="chat">Chat</div>
                        <div class="chat-messages" id="youtubeChat"></div>
                        <div class="panel-input">
                            <input type="text" id="youtubeChatInput" class="input-field" placeholder="Chat..." style="flex: 1;" onkeypress="if(event.key==='Enter') sendYouTubeChat()">
                            <button class="send-btn" onclick="sendYouTubeChat()" style="width: 32px;">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="modal" onclick="if(event.target === this) closeReplyModal()">
        <div class="modal-dialog">
            <div class="modal-dialog-header">
                <div>Reply to Post</div>
                <button class="modal-dialog-close" onclick="closeReplyModal()">X</button>
            </div>
            <div class="modal-dialog-body">
                <div id="replyContent"></div>
                <div class="input-group">
                    <div class="input-label">Your Reply</div>
                    <textarea id="replyInput" class="input-box" placeholder="Write your reply..." maxlength="280" style="height: 100px; resize: none;"></textarea>
                </div>
                <button class="submit-btn" onclick="submitReply()">Post Reply</button>
            </div>
        </div>
    </div>

    <!-- Add Video Modal -->
    <div id="addVideoModal" class="modal" onclick="if(event.target === this) closeAddVideoModal()">
        <div class="modal-dialog">
            <div class="modal-dialog-header">
                <div>Add Video to Queue</div>
                <button class="modal-dialog-close" onclick="closeAddVideoModal()">X</button>
            </div>
            <div class="modal-dialog-body">
                <div class="input-group">
                    <div class="input-label">YouTube Video ID</div>
                    <input type="text" id="addVideoId" class="input-box" placeholder="e.g., dQw4w9WgXcQ">
                </div>
                <div class="input-group">
                    <div class="input-label">Video Title</div>
                    <input type="text" id="addVideoTitle" class="input-box" placeholder="Enter title">
                </div>
                <button class="submit-btn" onclick="addVideoToQueue()">Add to Queue</button>
            </div>
        </div>
    </div>

    <button class="fab" onclick="openComposeModal()">+</button>

    <!-- 投稿作成モーダル -->
    <div id="composeModal" class="compose-modal" onclick="if(event.target === this) closeComposeModal()">
        <div class="compose-dialog">
            <div class="compose-header">
                <button class="compose-close-btn" onclick="closeComposeModal()">✕</button>
            </div>
            <div class="compose-body">
                <div class="compose-header-row">
                    <div class="compose-avatar" id="composeAvatar">U</div>
                    <div class="compose-info">
                        <div class="compose-name" id="composeName">User</div>
                        <div class="compose-id" id="composeId">#0000000</div>
                    </div>
                </div>

                <div class="compose-reply-option">
                    <span data-translate="replyingTo">Everyone can reply</span>
                </div>

                <div class="compose-textarea-container">
                    <textarea id="composeTextarea" class="compose-textarea" placeholder="Share a Gofile URL, Twitter Video, or safe website link..." maxlength="500"></textarea>
                </div>

                <input type="text" id="composeHashtags" class="compose-textarea" placeholder="#hashtag #example (separated by space)" style="min-height: 40px; padding: 12px;" maxlength="200">

                <input type="url" id="composeUrlInput" class="compose-url-input" placeholder="https://example.com" maxlength="2048">

                <div class="compose-toolbar">
                    <button class="compose-toolbar-btn" title="Add URL" onclick="openURLModal()">
                        <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    </button>
                </div>

                <!-- メディアプレビュー -->
                <div class="compose-media-preview" id="composeMediaPreview" style="display: none;"></div>

                <!-- URLプレビュー -->
                <div id="composeURLPreview"></div>
            </div>

            <div class="compose-footer">
                <button class="compose-post-btn" onclick="postCompose()" id="composePostBtn" data-translate="post">Post</button>
            </div>
        </div>
    </div>

    <!-- FAB ボタン -->
    <button class="fab" onclick="openComposeModal()">+</button>

    <!-- Advertisement Container -->
    
    <!-- 1. SmartLink Advertisement - Fixed Right Side (非表示、ユーザー操作時に表示) -->
    <div id="ad-smartlink" style="position: fixed; bottom: 100px; right: 20px; z-index: 400; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.3); display: none;">
        <a href="https://engagementidentifiers.com/qst8wwse?key=385ee7d478d037878c615a8416a3507a" target="_blank" rel="noopener noreferrer" style="text-decoration: none; display: block;">
            <div style="background: linear-gradient(135deg, #1d9bf0, #00d9ff); color: white; padding: 10px 15px; border-radius: 4px; font-weight: bold; font-size: 12px; text-align: center; cursor: pointer;">
                🎁 Special Offer<br>Click Here →
            </div>
        </a>
    </div>

    <!-- 3. Scrollbar Advertisement -->
    <script src="https://engagementidentifiers.com/d2/d3/3b/d2d33b5038b795c6408dcadeef8784ba.js"></script>
    
    <!-- 4. Banner Advertisement (320x50) - Bottom -->
    <div id="ad-banner-bottom" style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 300; background: white; padding: 8px 0; border-top: 1px solid #eee; display: none;">
        <script>
            atOptions = {
                'key' : '231e5c9092a3f60264c9edcc16e5374f',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script src="https://engagementidentifiers.com/231e5c9092a3f60264c9edcc16e5374f/invoke.js"></script>
    </div>


    <!-- URL追加モーダル -->
    <div id="urlModal" class="modal" onclick="if(event.target === this) closeURLModal()">
        <div class="modal-dialog">
            <div class="modal-dialog-header">
                <div>Add URL</div>
                <button class="modal-dialog-close" onclick="closeURLModal()">X</button>
            </div>
            <div class="modal-dialog-body">
                <div class="input-group">
                    <div class="input-label">URL</div>
                    <input type="text" id="urlInput" class="input-box" placeholder="https://example.com">
                </div>
                <button class="submit-btn" onclick="fetchURLPreview()">Preview</button>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- PulseNote Core Algorithm Module -->
    <script>
        /**
         * Twittex Core Module
         * アルゴリズム、重複検出、スパム判定
         */
        class TwittexAlgorithm {
            constructor() {
                this.posts = [];
                this.config = {
                    impressionDecayFactor: 0.95,
                    engagementWeight: 0.6,
                    recencyWeight: 0.3,
                    diversityWeight: 0.1,
                    minImpressionThreshold: 10,
                    maxFeedSize: 50,
                    impressionCacheTTL: 3600000,
                    spamDetectionWindow: 300000, // 5分
                    maxPostsPerWindow: 3, // 5分以内の最大投稿数
                    contentSimilarityThreshold: 0.85 // 85%以上が重複
                };
                this.userPostTimestamps = new Map();
                this.feedCache = new Map();
            }

            /**
             * 重複投稿を検出
             */
            detectDuplicate(content, allPosts) {
                return allPosts.some(post => 
                    this.calculateSimilarity(content, post.content) > this.config.contentSimilarityThreshold
                );
            }

            /**
             * 2つのテキストの類似度を計算（簡易版）
             */
            calculateSimilarity(text1, text2) {
                const normalize = (t) => t.toLowerCase().trim();
                const t1 = normalize(text1);
                const t2 = normalize(text2);
                
                if (t1 === t2) return 1.0;
                
                // Levenshtein 距離の簡易版
                const longer = t1.length > t2.length ? t1 : t2;
                const shorter = t1.length > t2.length ? t2 : t1;
                
                const editDistance = this.levenshteinDistance(shorter, longer);
                return 1.0 - (editDistance / longer.length);
            }

            /**
             * Levenshtein 距離を計算
             */
            levenshteinDistance(str1, str2) {
                const m = str1.length;
                const n = str2.length;
                const dp = Array(n + 1).fill(0).map(() => Array(m + 1).fill(0));
                
                for (let i = 0; i <= m; i++) dp[0][i] = i;
                for (let j = 0; j <= n; j++) dp[j][0] = j;
                
                for (let j = 1; j <= n; j++) {
                    for (let i = 1; i <= m; i++) {
                        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                        dp[j][i] = Math.min(
                            dp[j][i - 1] + 1,
                            dp[j - 1][i] + 1,
                            dp[j - 1][i - 1] + cost
                        );
                    }
                }
                return dp[n][m];
            }

            /**
             * スパムを判定
             */
            detectSpam(userId, allPosts) {
                const now = Date.now();
                const userPosts = allPosts.filter(p => p.creatorName === userId);
                
                // 最後の5分以内の投稿数をチェック
                const recentPosts = userPosts.filter(p => 
                    (now - new Date(p.createdAt).getTime()) < this.config.spamDetectionWindow
                );
                
                return {
                    isSpam: recentPosts.length >= this.config.maxPostsPerWindow,
                    recentPostCount: recentPosts.length,
                    maxAllowed: this.config.maxPostsPerWindow
                };
            }

            /**
             * トレンディング投稿を取得（時間範囲指定）
             */
            getTrendingPosts(allPosts, timeRangeHours = 24, limit = 10) {
                const now = Date.now();
                const cutoffTime = now - (timeRangeHours * 3600000);
                
                // 時間範囲内の投稿をフィルター
                const recentPosts = allPosts.filter(p => 
                    new Date(p.createdAt).getTime() > cutoffTime
                );
                
                // トレンドスコアを計算してソート
                return recentPosts
                    .map(post => ({
                        ...post,
                        trendScore: this.calculateTrendScore(post, now)
                    }))
                    .sort((a, b) => b.trendScore - a.trendScore)
                    .slice(0, limit);
            }

            /**
             * トレンドスコアを計算
             */
            calculateTrendScore(post, now) {
                const ageInHours = (now - new Date(post.createdAt).getTime()) / 3600000;
                const likes = post.engagementCount?.likes || 0;
                const reposts = post.engagementCount?.reposts || 0;
                const replies = post.engagementCount?.replies || 0;
                const impressions = post.impressionCount || Math.max(1, likes + reposts + replies);
                
                const engagementRate = (likes + (reposts * 2) + (replies * 3)) / Math.max(1, impressions);
                
                // 最近のエンゲージメント率を重視（6時間で減衰）
                return engagementRate * Math.exp(-ageInHours / 6);
            }

            /**
             * ハイブリッドフィードを生成
             */
            generateFeed(allPosts, userId) {
                const scoredPosts = allPosts.map(post => ({
                    ...post,
                    score: this.calculatePostScore(post)
                }));
                
                return scoredPosts
                    .sort((a, b) => b.score - a.score)
                    .slice(0, this.config.maxFeedSize);
            }

            /**
             * 投稿スコアを計算
             */
            calculatePostScore(post) {
                const likes = post.engagementCount?.likes || 0;
                const reposts = post.engagementCount?.reposts || 0;
                const replies = post.engagementCount?.replies || 0;
                const impressions = post.impressionCount || 1;
                
                const engagementScore = (likes + (reposts * 2) + (replies * 3)) / Math.max(1, impressions);
                const ageInHours = (Date.now() - new Date(post.createdAt).getTime()) / 3600000;
                const recencyScore = Math.exp(-ageInHours / 24);
                
                return (engagementScore * this.config.engagementWeight) +
                       (recencyScore * this.config.recencyWeight);
            }
        }

        // グローバルインスタンス
        const twittexAlgorithm = new TwittexAlgorithm();
    </script>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // SEO用の動的metaタグ更新関数
        function updateMetaTags(title, description, url, imageUrl) {
            // タイトル更新
            document.title = title || 'PulseNote - Anonymous Social Network for Pulse';
            
            // Description更新
            const descMeta = document.querySelector('meta[name="description"]');
            if (descMeta) {
                descMeta.setAttribute('content', description || 'Share your pulse anonymously on PulseNote.');
            }
            
            // OG Tags更新
            updateOGTag('og:title', title || 'PulseNote - Anonymous Social Network');
            updateOGTag('og:description', description || 'Share your pulse anonymously.');
            updateOGTag('og:url', url || 'https://twittex.space');
            updateOGTag('og:image', imageUrl || 'https://twittex.space/images/og-image.png');
            
            // Twitter Cards更新
            updateMeta('twitter:title', title || 'PulseNote - Anonymous Social Network');
            updateMeta('twitter:description', description || 'Share your pulse anonymously.');
            updateMeta('twitter:image', imageUrl || 'https://twittex.space/images/twitter-image.png');
        }

        function updateOGTag(property, content) {
            let meta = document.querySelector(`meta[property="${property}"]`);
            if (!meta) {
                meta = document.createElement('meta');
                meta.setAttribute('property', property);
                document.head.appendChild(meta);
            }
            meta.setAttribute('content', content);
        }

        function updateMeta(name, content) {
            let meta = document.querySelector(`meta[name="${name}"]`);
            if (!meta) {
                meta = document.createElement('meta');
                meta.setAttribute('name', name);
                document.head.appendChild(meta);
            }
            meta.setAttribute('content', content);
        }

        // URLコピー時にmetaタグを更新
        function copyRoomUrl() {
            const urlInput = document.getElementById('roomUrlDisplay');
            urlInput.select();
            document.execCommand('copy');
            
            // YouTubeルーム情報を基にmetaタグを更新
            if (currentYouTubeRoom) {
                const roomUrl = getRoomUrl(currentYouTubeRoom.id);
                const description = `Join my YouTube room: "${currentYouTubeRoom.title}" on PulseNote. Watch together in real-time!`;
                updateMetaTags(
                    `${currentYouTubeRoom.title} - PulseNote Room`,
                    description,
                    roomUrl,
                    'https://twittex.space/images/youtube-room.png'
                );
            }
            
            showNotification('Copied', 'Room URL copied to clipboard');
        }

        // 投稿作成時にmetaタグを更新
        function postCompose() {
            const content = document.getElementById('composeTextarea').value.trim();
            const account = Storage.getAccount();

            if (!content) {
                showNotification('Error', 'Please enter some text');
                return;
            }

            const post = {
                id: `post_${Date.now()}`,
                displayName: account.name,
                anonymousId: account.id,
                content: content,
                createdAt: new Date().toISOString(),
                engagementCount: { replies: 0, shares: 0 }
            };

            Storage.addPost(post);
            
            // 投稿作成時にメタタグを更新
            const postUrl = `https://twittex.space?post=${post.id}`;
            const postDescription = `${content.substring(0, 100)}${content.length > 100 ? '...' : ''} - Posted on PulseNote`;
            updateMetaTags(
                'New Post on PulseNote',
                postDescription,
                postUrl,
                'https://twittex.space/images/post.png'
            );
            
            showNotification('Success', 'Post created!');
            closeComposeModal();
            loadFeed();
            loadTrending();
        }

        // Q&A作成時にmetaタグを更新
        function submitQuestion() {
            const question = document.getElementById('qaQuestionInput').value.trim();
            const category = document.getElementById('qaCategory').value;
            const account = Storage.getAccount();

            if (!question) {
                showNotification('Error', 'Please enter a question');
                return;
            }

            const qa = {
                id: `qa_${Date.now()}`,
                question: question,
                category: category,
                askedBy: account.name,
                askedAt: new Date().toISOString(),
                answers: [],
                views: 0,
                helpful: 0
            };

            Storage.addQA(qa);
            
            // Q&A作成時にメタタグを更新
            const qaUrl = `https://twittex.space?qa=${qa.id}`;
            const qaDescription = `Q: ${question.substring(0, 80)}${question.length > 80 ? '...' : ''} - Ask and answer on PulseNote`;
            updateMetaTags(
                'New Question on PulseNote',
                qaDescription,
                qaUrl,
                'https://twittex.space/images/qa.png'
            );
            
            document.getElementById('qaQuestionInput').value = '';
            showNotification('Success', 'Question posted!');
            openQAModal();
        }
        const countryToLanguage = {
            'JP': 'ja',
            'US': 'en', 'GB': 'en', 'CA': 'en', 'AU': 'en',
            'ES': 'es', 'MX': 'es', 'AR': 'es',
            'FR': 'fr', 'CH': 'fr', 'BE': 'fr',
            'CN': 'zh', 'TW': 'zh', 'HK': 'zh'
        };

        let currentLanguage = 'en';
        let translations = {};
        let currentQA = null;

        async function detectLanguageByGeolocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const userCountry = data.country_code;
                
                const detectedLang = countryToLanguage[userCountry] || 'en';
                
                if (!localStorage.getItem('language')) {
                    await loadLanguage(detectedLang);
                } else {
                    const savedLang = localStorage.getItem('language');
                    await loadLanguage(savedLang);
                }
            } catch (error) {
                console.error('Geolocation detection failed:', error);
                const savedLang = localStorage.getItem('language') || 'en';
                await loadLanguage(savedLang);
            }
        }

        async function loadLanguage(lang) {
            try {
                const response = await fetch(`./locales_${lang}.json`);
                translations = await response.json();
                currentLanguage = lang;
                updateUI();
                localStorage.setItem('language', lang);
            } catch (error) {
                console.error('Language load failed:', error);
            }
        }

        function t(key) {
            return translations[key] || key;
        }

        function updateUI() {
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.textContent = t(key);
            });
        }

        function generateRandomName() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let name = '';
            for (let i = 0; i < 7; i++) {
                name += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return name;
        }

        function generateRoomId() {
            return `yt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function getRoomUrl(roomId) {
            return `${window.location.origin}?room=${roomId}`;
        }

        const WelcomeMessages = [
            "Welcome to Gsh!\nYour personal AI assistant is ready to help. Ask me anything!",
            "Hello and welcome!\nI'm Gsh, here to assist you with any questions or conversations you'd like to have.",
            "Greetings!\nThank you for visiting Gsh. Let's have a great conversation together.",
            "Welcome aboard!\nI'm Gsh, your AI companion. Feel free to ask me anything on your mind.",
            "Hi there!\nWelcome to Gsh. I'm excited to chat with you. What would you like to talk about?"
        ];

        let currentReplyPost = null;

        function filterByHashtag(hashtag) {
            const feed = document.getElementById('feed');
            const posts = Storage.getPosts();
            const cleanTag = hashtag.toLowerCase();
            
            const filteredPosts = posts.filter(post => 
                post.hashtags && post.hashtags.includes(cleanTag)
            );

            if (filteredPosts.length === 0) {
                feed.innerHTML = `
                    <div style="padding: 32px 16px; text-align: center;">
                        <div style="font-size: 16px; color: var(--text-primary); margin-bottom: 8px;">No posts with #${hashtag}</div>
                        <button class="submit-btn" onclick="loadFeed()" style="width: auto; margin-top: 16px;">Back to Feed</button>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="padding: 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); margin-bottom: 8px; text-align: center;">
                    <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">#${hashtag}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${filteredPosts.length} posts</div>
                    <button class="submit-btn" onclick="loadFeed()" style="width: auto; margin-top: 12px; font-size: 12px;">Back to Feed</button>
                </div>
            `;

            filteredPosts.forEach(post => {
                let mediaHTML = '';

                if (post.images && post.images.length > 0) {
                    mediaHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 12px;">`;
                    post.images.forEach(img => {
                        mediaHTML += `<img src="${img.data}" alt="post image" style="border-radius: 8px; max-width: 100%; height: auto;">`;
                    });
                    mediaHTML += `</div>`;
                }

                if (post.urls && post.urls.length > 0) {
                    post.urls.forEach(url => {
                        mediaHTML += `
                            <a href="${url.url}" target="_blank" style="text-decoration: none;">
                                <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" onmouseout="this.style.backgroundColor='var(--bg-secondary)'">
                                    <div style="display: flex; gap: 12px;">
                                        ${url.image ? `
                                            <div style="width: 100px; height: 80px; border-radius: 6px; overflow: hidden; background: var(--bg-primary); flex-shrink: 0;">
                                                <img src="${url.image}" alt="preview" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">
                                            </div>
                                        ` : ''}
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${url.title}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${url.description}</div>
                                            <div style="font-size: 11px; color: var(--primary);">${url.domain}</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        `;
                    });
                }

                html += `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-avatar">${post.displayName.charAt(0).toUpperCase()}</div>
                            <div class="post-info">
                                <div class="post-meta">
                                    <span class="post-name">${post.displayName}</span>
                                    <span class="post-id">${post.anonymousId}</span>
                                    <span class="post-time">${formatTime(post.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${post.hashtags && post.hashtags.length > 0 ? `
                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                                ${post.hashtags.map(tag => `
                                    <span style="padding: 4px 10px; background: rgba(29, 155, 240, 0.1); border-radius: 16px; font-size: 12px; color: var(--primary); cursor: pointer;" onclick="filterByHashtag('${tag}')">#${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${mediaHTML}
                        <div class="post-actions">
                            <div class="action-item">👁 ${post.views || 0}</div>
                            <div class="action-item" onclick="event.stopPropagation(); openReplyModal(${JSON.stringify(post).replace(/"/g, '&quot;')})">💬 ${post.engagementCount?.replies || 0}</div>
                            <div class="action-item">↗ ${post.engagementCount?.shares || 0}</div>
                        </div>
                    </div>
                `;
            });

            feed.innerHTML = html;
        }

        // コメント表示モーダル
        async function openCommentsModal(postId, creatorName) {
            const comments = await fetchCommentsFromGitHub(postId);
            const account = Storage.getAccount();
            
            const modalHTML = `
                <div id="commentsModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                " onclick="if(event.target.id === 'commentsModal') document.getElementById('commentsModal').remove();">
                    <div style="
                        background: var(--bg-primary);
                        border-radius: 12px;
                        width: 90%;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                        border: 1px solid var(--border);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- ヘッダー -->
                        <div style="
                            padding: 16px;
                            border-bottom: 1px solid var(--border);
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            position: sticky;
                            top: 0;
                            background: var(--bg-primary);
                        ">
                            <h2 style="margin: 0; font-size: 18px; color: var(--text-primary);">
                                Comments (${comments.length})
                            </h2>
                            <button onclick="document.getElementById('commentsModal').remove();" style="
                                background: none;
                                border: none;
                                color: var(--text-secondary);
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 32px;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">✕</button>
                        </div>
                        
                        <!-- コメント一覧 -->
                        <div style="padding: 16px; flex: 1; overflow-y: auto;">
                            ${comments.length > 0 ? comments.map(comment => `
                                <div style="
                                    padding: 12px;
                                    margin-bottom: 12px;
                                    background: var(--bg-secondary);
                                    border-radius: 8px;
                                    border-left: 3px solid var(--primary);
                                ">
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 8px;
                                    ">
                                        <div style="
                                            font-weight: 600;
                                            color: var(--text-primary);
                                            font-size: 14px;
                                        ">
                                            ${comment.name || 'Anonymous'}
                                        </div>
                                        <div style="
                                            font-size: 12px;
                                            color: var(--text-secondary);
                                        ">
                                            ${comment.createdAt ? formatTime(comment.createdAt) : ''}
                                        </div>
                                    </div>
                                    <div style="
                                        color: var(--text-primary);
                                        font-size: 14px;
                                        line-height: 1.5;
                                        word-break: break-word;
                                    ">
                                        ${comment.text || ''}
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align: center; color: var(--text-secondary); padding: 24px;">No comments yet</div>'}
                        </div>

                        <!-- コメント入力フォーム -->
                        <div style="
                            padding: 16px;
                            border-top: 1px solid var(--border);
                            background: var(--bg-secondary);
                        ">
                            <textarea id="commentInput_${postId}" placeholder="Write a comment..." style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                background: var(--bg-primary);
                                color: var(--text-primary);
                                font-size: 14px;
                                min-height: 60px;
                                font-family: inherit;
                                resize: vertical;
                            "></textarea>
                            <button onclick="submitComment('${postId}', '${account.id}', document.getElementById('commentInput_${postId}').value)" style="
                                width: 100%;
                                margin-top: 8px;
                                padding: 8px 16px;
                                background: var(--primary);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Post Comment</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // コメントを送信
        async function submitComment(postId, userId, text) {
            const text_trimmed = text.trim();
            
            if (!text_trimmed) {
                alert('Please write a comment');
                return;
            }

            if (text_trimmed.length > 500) {
                alert('Comment is too long (max 500 characters)');
                return;
            }

            // コメントを送信
            const dm = await sendCommentToGitHub(postId, userId, text_trimmed);

            if (dm) {
                // フィードから該当の Post を取得してコメント数を更新
                const posts = Storage.getPosts();
                const post = posts.find(p => p.id === postId);
                if (post) {
                    if (!post.engagementCount) post.engagementCount = {};
                    post.engagementCount.replies = (post.engagementCount.replies || 0) + 1;
                    Storage.setPosts(posts);
                }
                
                // モーダルを閉じてから再度開く（更新される）
                document.getElementById('commentsModal').remove();
                await openCommentsModal(postId, '');
            }
        }

        async function openReplyModal(post) {
            currentReplyPost = post;
            const modal = document.getElementById('replyModal');
            const replyContent = document.getElementById('replyContent');
            
            // 元の投稿を表示
            let replyContentHTML = `
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${post.displayName}</div>
                    <div style="font-size: 14px; color: var(--text-primary); line-height: 1.5;">${post.content}</div>
                </div>
            `;
            
            // GitHub からコメントを取得
            try {
                const comments = await fetchCommentsFromGitHub(post.id);
                
                if (comments && comments.length > 0) {
                    replyContentHTML += `
                        <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px; font-size: 12px;">
                                💬 ${comments.length} Comments
                            </div>
                    `;
                    
                    comments.forEach(comment => {
                        replyContentHTML += `
                            <div style="padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 4px; border-left: 2px solid var(--primary);">
                                <div style="font-weight: 600; font-size: 12px; color: var(--text-primary); margin-bottom: 4px;">
                                    ${comment.name || 'Anonymous'}
                                </div>
                                <div style="font-size: 12px; color: var(--text-primary); line-height: 1.4; margin-bottom: 4px;">
                                    ${comment.text || ''}
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ${comment.createdAt ? formatTime(comment.createdAt) : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    replyContentHTML += `</div>`;
                }
            } catch (error) {
                console.warn('Error loading comments:', error);
            }
            
            replyContent.innerHTML = replyContentHTML;
            modal.classList.add('open');
            document.getElementById('replyInput').focus();
        }

        function closeReplyModal() {
            document.getElementById('replyModal').classList.remove('open');
            document.getElementById('replyInput').value = '';
            currentReplyPost = null;
        }

        function submitReply() {
            if (!currentReplyPost) return;

            const replyText = document.getElementById('replyInput').value.trim();
            const account = Storage.getAccount();

            if (!replyText) {
                showNotification('Error', 'Please enter a reply');
                return;
            }

            // GitHub APIに送信
            sendCommentToGitHub(currentReplyPost.id, replyText, account.name);

            // 返信をカウント
            currentReplyPost.engagementCount.replies = (currentReplyPost.engagementCount.replies || 0) + 1;
            
            // 返信内容を保存
            if (!currentReplyPost.replies) currentReplyPost.replies = [];
            currentReplyPost.replies.push({
                id: `reply_${Date.now()}`,
                author: account.name,
                content: replyText,
                createdAt: new Date().toISOString()
            });

            const posts = Storage.getPosts();
            const idx = posts.findIndex(p => p.id === currentReplyPost.id);
            if (idx >= 0) {
                posts[idx] = currentReplyPost;
                localStorage.setItem('pulseNetworkPosts', JSON.stringify(posts));
            }

            // 返信通知を送信（投稿者へ）
            if (account.name !== currentReplyPost.displayName) {
                Storage.addNotification({
                    title: 'New Reply',
                    text: `${account.name} replied to your post`,
                    from: account.name,
                    type: 'reply'
                });
            }

            showNotification('Success', 'Reply posted!');
            closeReplyModal();
            loadFeed();
            loadTrending();
        }
        let youtubeQueue = [];
        let updateInterval = null;
        let allPosts = [];
        let allYouTubeRooms = [];
        let allQAs = [];

        const Storage = {
            getAccount() {
                const account = localStorage.getItem('pulseAccount');
                return account ? JSON.parse(account) : null;
            },

            setAccount(account) {
                localStorage.setItem('pulseAccount', JSON.stringify(account));
            },

            getNotifications() {
                const notifs = localStorage.getItem('notifications');
                return notifs ? JSON.parse(notifs) : [];
            },

            addNotification(notification) {
                const notifs = this.getNotifications();
                notifs.unshift({
                    id: Date.now(),
                    ...notification,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                localStorage.setItem('notifications', JSON.stringify(notifs));
                updateNotificationUI();
            },

            markNotificationsAsRead() {
                const notifs = this.getNotifications();
                notifs.forEach(n => n.read = true);
                localStorage.setItem('notifications', JSON.stringify(notifs));
            },

            getYouTubeRooms() {
                const rooms = localStorage.getItem('youtubeRooms');
                return rooms ? JSON.parse(rooms) : [];
            },

            addYouTubeRoom(room) {
                const rooms = this.getYouTubeRooms();
                rooms.unshift(room);
                localStorage.setItem('youtubeRooms', JSON.stringify(rooms));
            },

            getYouTubeRoom(roomId) {
                const rooms = this.getYouTubeRooms();
                return rooms.find(r => r.id === roomId);
            },

            updateYouTubeRoom(roomId, room) {
                const rooms = this.getYouTubeRooms();
                const idx = rooms.findIndex(r => r.id === roomId);
                if (idx >= 0) {
                    rooms[idx] = room;
                    localStorage.setItem('youtubeRooms', JSON.stringify(rooms));
                }
            },

            getPosts() {
                const posts = localStorage.getItem('pulseNetworkPosts');
                return posts ? JSON.parse(posts) : [];
            },

            addPost(post) {
                const posts = this.getPosts();
                posts.unshift(post);
                localStorage.setItem('pulseNetworkPosts', JSON.stringify(posts));
            },

            getQAs() {
                const qas = localStorage.getItem('pulseQAs');
                return qas ? JSON.parse(qas) : [];
            },

            addQA(qa) {
                const qas = this.getQAs();
                qas.unshift(qa);
                localStorage.setItem('pulseQAs', JSON.stringify(qas));
            },

            getQA(qaId) {
                const qas = this.getQAs();
                return qas.find(q => q.id === qaId);
            },

            updateQA(qaId, qa) {
                const qas = this.getQAs();
                const idx = qas.findIndex(q => q.id === qaId);
                if (idx >= 0) {
                    qas[idx] = qa;
                    localStorage.setItem('pulseQAs', JSON.stringify(qas));
                }
            },

            getAIHistory() {
                const history = localStorage.getItem('gshHistory');
                return history ? JSON.parse(history) : [];
            },

            addAIMessage(role, content) {
                const history = this.getAIHistory();
                history.push({ role, content, timestamp: new Date().toISOString() });
                localStorage.setItem('gshHistory', JSON.stringify(history));
            }
        };

        // Sidebar Drawer Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            // モバイルのみドロワー機能
            if (window.innerWidth > 768) {
                return;
            }
            
            if (sidebar.classList.contains('drawer-open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function openSidebar() {
            // モバイルのみ
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                
                sidebar.classList.remove('drawer-closed');
                sidebar.classList.add('drawer-open');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeSidebar() {
            // モバイルのみ
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                
                sidebar.classList.remove('drawer-open');
                sidebar.classList.add('drawer-closed');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Close sidebar when window is resized to larger screen
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('drawer-closed', 'drawer-open');
                document.body.style.overflow = '';
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }
        });

        // Show/Hide FAB when modal is open/closed
        const originalOpenComposeModal = window.openComposeModal;
        window.openComposeModal = function() {
            document.querySelector('.fab').style.display = 'none';
            originalOpenComposeModal.call(this);
        };

        const originalCloseComposeModal = window.closeComposeModal;
        window.closeComposeModal = function() {
            document.querySelector('.fab').style.display = 'flex';
            originalCloseComposeModal.call(this);
        };

        async function init() {
            // モバイルの場合、初期クラスを設定
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('drawer-closed');
            }

            await detectLanguageByGeolocation();

            let account = Storage.getAccount();
            if (!account) {
                account = {
                    name: generateRandomName(),
                    id: `#${Math.floor(Math.random() * 10000000).toString().padStart(7, '0')}`,
                    avatar: generateRandomName().charAt(0)
                };
                Storage.setAccount(account);
            }

            updateAccountUI(account);

            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('room');
            if (roomId) {
                const room = Storage.getYouTubeRoom(roomId);
                if (room) {
                    openYouTubeWatchModal(room);
                } else {
                    showNotification('Error', 'Room not found');
                }
            } else {
                loadFeed();
                loadTrending();
            }
            
            // 広告を表示（2秒後）
            setTimeout(() => {
                // SmartLink 広告をユーザー操作後に表示
                if (window.innerWidth > 768) {
                    document.getElementById('ad-smartlink').style.display = 'block';
                }
                // Banner 広告をモバイルで表示
                if (window.innerWidth <= 768) {
                    document.getElementById('ad-banner-bottom').style.display = 'block';
                }
            }, 2000);
        }

        function updateAccountUI(account) {
            document.getElementById('accountName').textContent = account.name;
            document.getElementById('accountId').textContent = account.id;
            document.getElementById('accountAvatar').textContent = account.avatar;
        }

        function updateNotificationUI() {
            const notifs = Storage.getNotifications();
            const unreadCount = notifs.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadgeNav');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function showNotification(title, text) {
            Storage.addNotification({
                title,
                text,
                from: 'System'
            });

            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.textContent = `${title}: ${text}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function openNotificationModal() {
            const modal = document.getElementById('notificationModal');
            modal.style.display = 'flex';
            const notifs = Storage.getNotifications();

            modal.classList.add('open');
            Storage.markNotificationsAsRead();
            updateNotificationUI();

            const content = document.getElementById('notificationModalContent');
            if (notifs.length === 0) {
                content.innerHTML = `<div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">No notifications</div>`;
                return;
            }

            content.innerHTML = notifs.map(n => `
                <div class="notification-item">
                    <div class="notification-item-name">${n.from}</div>
                    <div class="notification-item-title">${n.title}</div>
                    <div class="notification-item-text">${n.text}</div>
                    <div class="notification-item-time">${formatTime(n.timestamp)}</div>
                </div>
            `).join('');
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            modal.style.display = 'none';
            modal.classList.remove('open');
        }

        function openSearchModal() {
            const searchModal = document.getElementById('searchModal');
            searchModal.style.display = 'flex';
            searchModal.classList.add('open');
            document.getElementById('searchInput').focus();
            document.getElementById('searchResults').innerHTML = '';
        }

        function closeSearchModal() {
            const searchModal = document.getElementById('searchModal');
            searchModal.style.display = 'none';
            searchModal.classList.remove('open');
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const results = document.getElementById('searchResults');

            console.log('🔍 Search Query:', query);

            if (!query) {
                results.innerHTML = '';
                return;
            }

            const posts = Storage.getPosts();
            const rooms = Storage.getYouTubeRooms();
            const qas = Storage.getQAs();

            console.log('📊 Data:', { postsCount: posts.length, roomsCount: rooms.length, qasCount: qas.length });

            // 投稿を検索（コンテンツまたは表示名で）
            const filteredPosts = posts.filter(p => 
                p.content.toLowerCase().includes(query) || 
                p.displayName.toLowerCase().includes(query) ||
                (p.anonymousId && p.anonymousId.toLowerCase().includes(query))
            );

            // ルームを検索
            const filteredRooms = rooms.filter(r => 
                r.title.toLowerCase().includes(query)
            );

            // Q&A を検索
            const filteredQAs = qas.filter(q => 
                q.question.toLowerCase().includes(query)
            );

            console.log('✅ Filtered:', { postsCount: filteredPosts.length, roomsCount: filteredRooms.length, qasCount: filteredQAs.length });

            let html = '';

            // YouTube ルームを表示
            filteredRooms.forEach(room => {
                html += `
                    <div class="search-result-item" onclick="closeSearchModal(); openYouTubeWatchModal(${JSON.stringify(room).replace(/"/g, '&quot;')})">
                        <div class="search-result-title">▶ ${room.title}</div>
                        <div class="search-result-meta">URL Room • ${room.createdAt.split('T')[0]}</div>
                    </div>
                `;
            });

            // Q&A を表示
            filteredQAs.forEach(qa => {
                html += `
                    <div class="search-result-item" onclick="closeSearchModal(); openQADetail(${JSON.stringify(qa).replace(/"/g, '&quot;')})">
                        <div class="search-result-title">❓ ${qa.question.substring(0, 50)}</div>
                        <div class="search-result-meta">Q&A • ${qa.askedAt.split('T')[0]}</div>
                    </div>
                `;
            });

            // 投稿を表示（上から順に）
            filteredPosts.forEach(post => {
                const postDate = post.createdAt ? new Date(post.createdAt).toLocaleDateString() : 'Unknown';
                html += `
                    <div class="search-result-item" onclick="closeSearchModal(); scrollToPost('${post.id}'); loadFeed();" style="cursor: pointer;">
                        <div style="display: flex; gap: 12px; width: 100%;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #00d9ff); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px; flex-shrink: 0;">
                                ${post.displayName.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div class="search-result-title" style="margin: 0; display: flex; gap: 8px; align-items: center;">
                                    <span>${post.displayName}</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">${post.anonymousId}</span>
                                </div>
                                <div class="search-result-meta" style="margin: 4px 0 0 0;">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    👁 ${post.views || 0} • 💬 ${post.engagementCount?.replies || 0} • ${postDate}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = `<div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">No results found for "${query}"</div>`;
            }

            console.log('🎨 Rendering HTML:', html.length, 'chars');
            results.innerHTML = html;
        }

        function openQAModal() {
            const modal = document.getElementById('qaModal');
            modal.style.display = 'flex';
            const qas = Storage.getQAs();

            modal.classList.add('open');

            const content = document.getElementById('qaModalContent');
            if (qas.length === 0) {
                content.innerHTML = `<div style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">No questions yet</div>`;
                return;
            }

            content.innerHTML = qas.map(qa => `
                <div class="qa-item" onclick="openQADetail(${JSON.stringify(qa).replace(/"/g, '&quot;')})">
                    <div class="qa-question">${qa.question}</div>
                    <div class="qa-meta">
                        <span class="qa-category">${qa.category}</span>
                        <span>${formatTime(qa.askedAt)}</span>
                    </div>
                    <div class="qa-stats">
                        <span>💬 ${qa.answers.length} answers</span>
                        <span>👁 ${qa.views} views</span>
                    </div>
                </div>
            `).join('');
        }

        function closeQAModal() {
            const modal = document.getElementById('qaModal');
            modal.style.display = 'none';
            modal.classList.remove('open');
        }

        function submitQuestion() {
            const question = document.getElementById('qaQuestionInput').value.trim();
            const category = document.getElementById('qaCategory').value;
            const account = Storage.getAccount();

            if (!question) {
                showNotification('Error', 'Please enter a question');
                return;
            }

            const qa = {
                id: `qa_${Date.now()}`,
                question: question,
                category: category,
                askedBy: account.name,
                askedAt: new Date().toISOString(),
                answers: [],
                views: 0,
                helpful: 0
            };

            Storage.addQA(qa);
            document.getElementById('qaQuestionInput').value = '';
            showNotification('Success', 'Question posted!');
            openQAModal();
        }

        function openQADetail(qa) {
            currentQA = qa;
            const modal = document.getElementById('qaDetailModal');
            const content = document.getElementById('qaDetailContent');

            modal.classList.add('open');

            content.innerHTML = `
                <div class="qa-detail-question">
                    <div class="qa-detail-question-text">${qa.question}</div>
                    <div class="qa-detail-question-meta">
                        <span class="qa-category">${qa.category}</span>
                        <span>Asked by ${qa.askedBy}</span>
                        <span>${formatTime(qa.askedAt)}</span>
                    </div>
                </div>

                <div class="qa-answers-section">
                    <div class="qa-answers-title">💬 ${qa.answers.length} Answers</div>
                    ${qa.answers.length === 0 ? 
                        '<div style="color: var(--text-secondary); font-size: 12px; padding: 12px;">No answers yet. Be the first to answer!</div>' 
                        : qa.answers.map(ans => `
                            <div class="qa-answer-item">
                                <div class="qa-answer-text">${ans.answer}</div>
                                <div class="qa-answer-meta">By ${ans.answeredBy} • ${formatTime(ans.answeredAt)}</div>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        function closeQADetailModal() {
            document.getElementById('qaDetailModal').classList.remove('open');
            currentQA = null;
        }

        function submitAnswer() {
            if (!currentQA) return;

            const answer = document.getElementById('qaAnswerInput').value.trim();
            const account = Storage.getAccount();

            if (!answer) {
                showNotification('Error', 'Please enter an answer');
                return;
            }

            const answerObj = {
                id: `ans_${Date.now()}`,
                answer: answer,
                answeredBy: account.name,
                answeredAt: new Date().toISOString(),
                helpful: 0
            };

            currentQA.answers.push(answerObj);
            Storage.updateQA(currentQA.id, currentQA);

            document.getElementById('qaAnswerInput').value = '';
            showNotification('Success', 'Answer posted!');
            openQADetail(currentQA);
        }

        function openAIModal() {
            const aiModal = document.getElementById('aiModal');
            aiModal.style.display = 'flex';
            aiModal.classList.add('open');
            document.getElementById('gshLogoHeader').classList.add('visible');
            
            const messages = document.getElementById('aiMessages');
            const welcome = WelcomeMessages[Math.floor(Math.random() * WelcomeMessages.length)];
            const welcomeEl = document.getElementById('welcomeMessage');
            welcomeEl.textContent = welcome;
            
            const history = Storage.getAIHistory();
            if (history.length > 0) {
                messages.innerHTML = history.map(msg => `
                    <div class="ai-message ${msg.role}">
                        ${msg.content}
                    </div>
                `).join('');
                messages.scrollTop = messages.scrollHeight;
            }
            
            document.getElementById('aiInput').focus();
        }

        function closeAIModal() {
            const aiModal = document.getElementById('aiModal');
            aiModal.style.display = 'none';
            aiModal.classList.remove('open');
            document.getElementById('gshLogoHeader').classList.remove('visible');
        }

        // AIモーダルを自動で閉じる（任意のナビゲーション項目クリック時）
        function closeAIModalAuto() {
            closeAIModal();
        }

        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();

            if (!message) return;

            const messages = document.getElementById('aiMessages');
            const welcome = messages.querySelector('.ai-welcome');
            if (welcome) {
                welcome.remove();
            }

            const userMsg = document.createElement('div');
            userMsg.className = 'ai-message user';
            userMsg.textContent = message;
            messages.appendChild(userMsg);

            Storage.addAIMessage('user', message);
            input.value = '';

            // APIを呼び出す
            callAIAPI(message).then(response => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'ai-message assistant';
                aiMsg.textContent = response.text || 'An error occurred. Please try again.';
                messages.appendChild(aiMsg);

                Storage.addAIMessage('assistant', response.text || 'An error occurred. Please try again.');
                messages.scrollTop = messages.scrollHeight;
            }).catch(error => {
                console.error('Error:', error);
                const aiMsg = document.createElement('div');
                aiMsg.className = 'ai-message assistant';
                aiMsg.textContent = 'An error occurred. Please try again.';
                messages.appendChild(aiMsg);
                messages.scrollTop = messages.scrollHeight;
            });
        }

        async function callAIAPI(prompt) {
            const apiUrl = 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQm5HUEtMSjJkakVjcF9IQ0M0VFhRQ0FmSnNDSHNYTlJSblE0UXo1Q3RBcjFPcl9YYy1OZUhteDZWekxHdWRLM1M1alNZTkJMWEhNOWd4S1NPSDBTWC12M0U2UGc9PQ==';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                return {
                    text: data.text || 'No response received',
                    status: data.status
                };
            } catch (error) {
                console.error('API Error:', error);
                return {
                    text: 'Unable to connect to AI service. Please try again.',
                    status: 'error'
                };
            }
        }

        // URL Viewer モーダルを開く（Gofile/Twitter Video/安全なサイト鑑賞）
        function openURLViewerModal() {
            document.getElementById('youtubeSetupModal').classList.add('open');
        }

        function closeYouTubeSetupModal() {
            document.getElementById('youtubeSetupModal').classList.remove('open');
        }

        function openYouTubeCreateModal() {
            closeYouTubeSetupModal();
            document.getElementById('youtubeCreateModal').classList.add('open');
        }

        function closeYouTubeCreateModal() {
            document.getElementById('youtubeCreateModal').classList.remove('open');
        }

        async function createYouTubeRoom() {
            const title = document.getElementById('youtubeTitle').value.trim();
            const videoId = document.getElementById('youtubeVideoId').value.trim();

            if (!title || !videoId) {
                showNotification(t('required'), t('fillAllFields'));
                return;
            }

            const roomId = generateRoomId();
            const room = {
                id: roomId,
                title: title,
                videoId: videoId,
                createdAt: new Date().toISOString(),
                messages: [],
                participants: [],
                queue: []
            };

            Storage.addYouTubeRoom(room);

            showNotification(t('success'), t('youtubeRoomCreated'));
            closeYouTubeCreateModal();
            document.getElementById('youtubeTitle').value = '';
            document.getElementById('youtubeVideoId').value = '';
            loadFeed();
            loadTrending();
            openYouTubeWatchModal(room);
        }

        function joinRoom() {
            const roomId = document.getElementById('joinRoomInput').value.trim();
            if (!roomId) return;

            const room = Storage.getYouTubeRoom(roomId);
            if (room) {
                closeYouTubeSetupModal();
                openYouTubeWatchModal(room);
            } else {
                showNotification('Error', 'Room not found');
            }
        }

        function openYouTubeWatchModal(room) {
            currentYouTubeRoom = room;
            youtubeQueue = room.queue || [];
            
            document.getElementById('youtubeWatchModal').classList.add('open');
            document.getElementById('youtubeRoomTitle').textContent = room.title;
            
            // メンバーを追加
            const account = Storage.getAccount();
            if (!room.participants) room.participants = [];
            if (!room.participants.includes(account.name)) {
                room.participants.push(account.name);
            }
            Storage.updateYouTubeRoom(room.id, room);
            
            // YouTubeプレーヤーをリセットして新規設定
            const youtubeUrl = `https://www.youtube.com/embed/${room.videoId}`;
            const playerContainer = document.querySelector('.youtube-player');
            
            // 古いiframeを削除
            const oldFrame = document.getElementById('youtubePlayer');
            if (oldFrame) {
                oldFrame.remove();
            }
            
            // 新しいiframeを作成
            const newFrame = document.createElement('iframe');
            newFrame.id = 'youtubePlayer';
            newFrame.className = 'youtube-iframe';
            newFrame.src = youtubeUrl;
            newFrame.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            newFrame.allowFullScreen = true;
            newFrame.frameborder = '0';
            newFrame.onload = function() {
                console.log('YouTube video loaded successfully');
            };
            newFrame.onerror = function() {
                console.error('YouTube video failed to load');
                playerContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--bg-secondary); color: var(--text-secondary); font-size: 14px; padding: 20px; text-align: center;">Video unavailable or restricted. Skipping...</div>';
                setTimeout(() => {
                    skipToNextVideo();
                }, 2000);
            };
            
            playerContainer.innerHTML = '';
            playerContainer.appendChild(newFrame);
            
            document.getElementById('roomUrlDisplay').value = getRoomUrl(room.id);
            document.getElementById('youtubeChat').innerHTML = '';
            
            loadQueueList();
            loadYouTubeChatMessages(room.id);

            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                if (document.getElementById('youtubeWatchModal').classList.contains('open') && currentYouTubeRoom) {
                    const freshRoom = Storage.getYouTubeRoom(currentYouTubeRoom.id);
                    if (freshRoom) {
                        currentYouTubeRoom = freshRoom;
                        youtubeQueue = freshRoom.queue || [];
                        loadQueueList();
                        loadYouTubeChatMessages(freshRoom.id);
                    } else {
                        // ルームが削除された場合
                        showNotification('Room closed', 'This room no longer exists');
                        closeYouTubeWatchModal();
                    }
                }
            }, 1000);
        }

        function skipToNextVideo() {
            if (!currentYouTubeRoom || !youtubeQueue || youtubeQueue.length <= 1) {
                showNotification('Queue empty', 'No more videos');
                return;
            }

            // キューの最初のビデオを削除
            youtubeQueue.shift();
            currentYouTubeRoom.queue = youtubeQueue;
            Storage.updateYouTubeRoom(currentYouTubeRoom.id, currentYouTubeRoom);

            if (youtubeQueue.length > 0) {
                // 次のビデオを再生
                const nextVideo = youtubeQueue[0];
                const youtubeUrl = `https://www.youtube.com/embed/${nextVideo.videoId}`;
                
                // iframeを再作成
                const playerContainer = document.querySelector('.youtube-player');
                const oldFrame = document.getElementById('youtubePlayer');
                if (oldFrame) {
                    oldFrame.remove();
                }
                
                const newFrame = document.createElement('iframe');
                newFrame.id = 'youtubePlayer';
                newFrame.className = 'youtube-iframe';
                newFrame.src = youtubeUrl;
                newFrame.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                newFrame.allowFullScreen = true;
                newFrame.frameborder = '0';
                playerContainer.innerHTML = '';
                playerContainer.appendChild(newFrame);
                
                loadQueueList();
                showNotification('Playing next', nextVideo.title);
            }
        }

        function closeYouTubeWatchModal() {
            document.getElementById('youtubeWatchModal').classList.remove('open');
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            currentYouTubeRoom = null;
            loadFeed();
            loadTrending();
        }

        function leaveYouTubeRoom() {
            if (!currentYouTubeRoom) return;

            const account = Storage.getAccount();
            const room = Storage.getYouTubeRoom(currentYouTubeRoom.id);

            if (room) {
                // メンバーリストから削除
                if (!room.participants) room.participants = [];
                room.participants = room.participants.filter(p => p !== account.name);

                // メンバーが0人になったらルームを削除
                if (room.participants.length === 0) {
                    const rooms = Storage.getYouTubeRooms();
                    const filteredRooms = rooms.filter(r => r.id !== room.id);
                    localStorage.setItem('youtubeRooms', JSON.stringify(filteredRooms));
                    showNotification('Left', 'Room closed (no members left)');
                } else {
                    // メンバーがいればルーム情報を更新
                    Storage.updateYouTubeRoom(room.id, room);
                    showNotification('Left', 'You left the room');
                }
            }

            closeYouTubeWatchModal();
            loadFeed();
            loadTrending();
        }

        function copyRoomUrl() {
            const urlInput = document.getElementById('roomUrlDisplay');
            urlInput.select();
            document.execCommand('copy');
            showNotification('Copied', 'Room URL copied to clipboard');
        }

        // Post のリンクをコピー
        async function copyPostLink(postId) {
            const url = `${window.location.origin}/?post=${postId}`;
            
            try {
                await navigator.clipboard.writeText(url);
                showNotification('Copied', 'Post link copied to clipboard');
            } catch (error) {
                // フォールバック: 古い方法
                const textarea = document.createElement('textarea');
                textarea.value = url;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Copied', 'Post link copied to clipboard');
            }
        }

        function closeAddVideoModal() {
            document.getElementById('addVideoModal').classList.remove('open');
        }

        function addVideoToQueue() {
            if (!currentYouTubeRoom) return;

            const videoId = document.getElementById('addVideoId').value.trim();
            const title = document.getElementById('addVideoTitle').value.trim();

            if (!videoId || !title) return;

            const account = Storage.getAccount();
            if (!youtubeQueue) youtubeQueue = [];

            youtubeQueue.push({
                videoId: videoId,
                title: title,
                addedBy: account.name,
                addedAt: new Date().toISOString()
            });

            currentYouTubeRoom.queue = youtubeQueue;
            Storage.updateYouTubeRoom(currentYouTubeRoom.id, currentYouTubeRoom);

            document.getElementById('addVideoId').value = '';
            document.getElementById('addVideoTitle').value = '';
            closeAddVideoModal();
            loadQueueList();
        }

        function loadQueueList() {
            const container = document.getElementById('queueList');
            
            if (!youtubeQueue || youtubeQueue.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 12px; color: var(--text-secondary); font-size: 12px;">No videos in queue</div>`;
                return;
            }

            container.innerHTML = youtubeQueue.map((item, idx) => `
                <div class="queue-item ${idx === 0 ? 'playing' : ''}">
                    <div class="queue-item-title">${idx === 0 ? '▶ Now: ' : `${idx}. `}${item.title}</div>
                    <div class="queue-item-meta">By ${item.addedBy}</div>
                </div>
            `).join('');
        }

        function loadYouTubeChatMessages(roomId) {
            const room = Storage.getYouTubeRoom(roomId);
            if (!room) return;

            const container = document.getElementById('youtubeChat');
            const messages = room.messages || [];
            
            container.innerHTML = messages.map(msg => `
                <div class="chat-message">
                    <div class="chat-message-name">${msg.userName}</div>
                    <div class="chat-message-text">${msg.content}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendYouTubeChat() {
            const input = document.getElementById('youtubeChatInput');
            const message = input.value.trim();

            if (!message || !currentYouTubeRoom) return;

            const account = Storage.getAccount();
            const room = Storage.getYouTubeRoom(currentYouTubeRoom.id);

            if (room) {
                if (!room.messages) room.messages = [];
                room.messages.push({
                    userName: account.name,
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                Storage.updateYouTubeRoom(room.id, room);
                currentYouTubeRoom = room;
                
                input.value = '';
                loadYouTubeChatMessages(room.id);
            }
        }

        function loadFeed() {
            const feed = document.getElementById('feed');
            let posts = Storage.getPosts();
            const rooms = Storage.getYouTubeRooms();

            allPosts = posts;
            allYouTubeRooms = rooms;

            // GitHubから投稿を取得してマージ
            fetchPostsFromGitHub().then(githubPosts => {
                if (githubPosts && githubPosts.length > 0) {
                    // ローカルとGitHub投稿をマージ（GitHubの投稿が優先）
                    const mergedPosts = mergePostsWithGitHub(posts, githubPosts);
                    posts = mergedPosts;
                    allPosts = posts;
                }
                
                renderFeed(feed, posts, rooms);
            }).catch(error => {
                console.warn('Failed to fetch GitHub posts, showing local posts only:', error);
                renderFeed(feed, posts, rooms);
            });
        }

        // GitHubから投稿を取得（アルゴリズム適用版）
        async function fetchPostsFromGitHub() {
            try {
                console.log('📥 Fetching posts from GitHub...');
                // fetch-github-posts を使用（アルゴリズム・スパムフィルタ適用）
                const response = await fetch('/.netlify/functions/fetch-github-posts');
                console.log('📤 Response status:', response.status);
                
                if (!response.ok) {
                    console.error('❌ GitHub fetch failed with status:', response.status);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✓ Fetched posts from GitHub:', data.count, 'posts');
                console.log('📋 Posts data:', data);
                return data.posts || [];
            } catch (error) {
                console.error('❌ Error fetching posts from GitHub:', error);
                return [];
            }
        }

        // ローカルとGitHub投稿をマージ
        function mergePostsWithGitHub(localPosts, githubPosts) {
            // GitHubの投稿IDセット
            const githubPostIds = new Set(githubPosts.map(p => p.id));

            // ローカルのみの投稿を抽出
            const onlyLocal = localPosts.filter(p => !githubPostIds.has(p.id));

            // マージ（GitHubの投稿が先）
            return [...githubPosts, ...onlyLocal];
        }

        // フィード表示処理を分離
        // コメントモーダルを閉じる
        function closeCommentsModal() {
            const modal = document.getElementById('commentsModal');
            if (modal) {
                modal.remove();
            }
        }

        // GitHub からコメントを取得（フォールバック: ローカル）
        // GitHub からDMを取得
        async function fetchDMsFromGitHub() {
            try {
                const response = await fetch('/.netlify/functions/fetch-dms');
                if (response.ok) {
                    const data = await response.json();
                    return data.dms || [];
                }
            } catch (error) {
                console.warn('GitHub DM fetch failed, using localStorage fallback:', error);
            }
            
            // フォールバック: ローカルストレージから DM を取得
            try {
                const dmsJson = localStorage.getItem('twittexDMs');
                if (dmsJson) {
                    const dms = JSON.parse(dmsJson);
                    console.log(`✓ Loaded ${dms.length} DMs from localStorage`);
                    return dms;
                }
            } catch (error) {
                console.error('Failed to load DMs from localStorage:', error);
            }
            
            return [];
        }

        // DM を送信
        async function sendDMToGitHub(fromUserId, toUserId, message) {
            try {
                const response = await fetch('/.netlify/functions/create-dm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fromUserId: fromUserId,
                        toUserId: toUserId,
                        message: message
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`✓ DM sent to ${toUserId}`);
                    return data.dm;
                }
            } catch (error) {
                console.warn('GitHub DM failed, using localStorage fallback:', error);
            }
            
            // フォールバック: ローカルストレージに保存
            try {
                const dm = {
                    id: 'dm_' + Date.now(),
                    fromUserId: fromUserId,
                    toUserId: toUserId,
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // ローカルストレージから DM リストを取得
                const dmsJson = localStorage.getItem('twittexDMs');
                const dms = dmsJson ? JSON.parse(dmsJson) : [];
                
                // 新しい DM を追加
                dms.push(dm);
                
                // ローカルストレージに保存
                localStorage.setItem('twittexDMs', JSON.stringify(dms));
                
                console.log(`✓ DM saved to localStorage: ${toUserId}`);
                return dm;
            } catch (error) {
                console.error('Failed to save DM:', error);
            }
            
            return null;
        }

        // DM モーダルを開く
        async function openDMModal() {
            document.getElementById('dmModal').classList.add('open');
            await loadDMList();
        }

        // DM モーダルを閉じる
        function closeDMModal() {
            document.getElementById('dmModal').classList.remove('open');
            backToDMList();
        }

        // DM リストを読み込み
        async function loadDMList() {
            const dms = await fetchDMsFromGitHub();
            const account = Storage.getAccount();
            
            // 現在のユーザーに対するDMをグループ化
            const dmGroups = {};
            
            dms.forEach(dm => {
                const otherUserId = dm.fromUserId === account.id ? dm.toUserId : dm.fromUserId;
                if (!dmGroups[otherUserId]) {
                    dmGroups[otherUserId] = [];
                }
                dmGroups[otherUserId].push(dm);
            });

            const dmList = document.getElementById('dmList');
            
            if (Object.keys(dmGroups).length === 0) {
                dmList.innerHTML = `
                    <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                        <div style="font-size:48px; margin-bottom:12px;">✉️</div>
                        <div>No messages yet</div>
                        <div style="font-size:12px; margin-top:8px;">Send someone a message to get started</div>
                    </div>
                `;
                return;
            }

            dmList.innerHTML = Object.entries(dmGroups).map(([userId, messages]) => {
                const lastMessage = messages[0];
                const isUnread = !lastMessage.read && lastMessage.toUserId === account.id;
                
                return `
                    <div class="dm-item" onclick="openDMChat('${userId}')" style="
                        padding: 12px;
                        border-bottom: 1px solid var(--border);
                        cursor: pointer;
                        background: ${isUnread ? 'rgba(29, 155, 240, 0.1)' : 'transparent'};
                        transition: background 0.2s;
                    " onmouseover="this.style.background='rgba(29, 155, 240, 0.05)'" onmouseout="this.style.background='${isUnread ? 'rgba(29, 155, 240, 0.1)' : 'transparent'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">${userId}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${lastMessage.message.substring(0, 50)}
                                </div>
                            </div>
                            ${isUnread ? '<div style="width:8px; height:8px; background:var(--primary); border-radius:50%;"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // DM チャットを開く
        async function openDMChat(toUserId) {
            const account = Storage.getAccount();
            const dms = await fetchDMsFromGitHub();
            
            // ユーザーとのDMをフィルタリング
            const userDMs = dms.filter(dm => 
                (dm.fromUserId === account.id && dm.toUserId === toUserId) ||
                (dm.fromUserId === toUserId && dm.toUserId === account.id)
            ).reverse();

            document.getElementById('dmList').style.display = 'none';
            document.getElementById('dmChatSection').style.display = 'flex';
            document.getElementById('dmChatSection').style.flexDirection = 'column';
            document.getElementById('dmChatUser').textContent = toUserId;

            const messagesContainer = document.getElementById('dmMessages');
            messagesContainer.innerHTML = userDMs.map(dm => `
                <div style="display: flex; justify-content: ${dm.fromUserId === account.id ? 'flex-end' : 'flex-start'}; word-wrap: break-word;">
                    <div style="
                        max-width: 60%;
                        padding: 8px 12px;
                        border-radius: 8px;
                        background: ${dm.fromUserId === account.id ? 'var(--primary)' : 'var(--bg-secondary)'};
                        color: ${dm.fromUserId === account.id ? 'white' : 'var(--text-primary)'};
                        word-break: break-word;
                        white-space: pre-wrap;
                    ">
                        <div style="margin-bottom: 4px;">${dm.message}</div>
                        <div style="font-size: 11px; opacity: 0.7;">
                            ${formatTime(dm.createdAt)}
                        </div>
                    </div>
                </div>
            `).join('');

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            document.getElementById('dmInput').focus();
            
            // グローバル変数にtoUserIdを保存
            window.currentDMUser = toUserId;
        }

        // DM リストに戻る
        function backToDMList() {
            document.getElementById('dmList').style.display = 'block';
            document.getElementById('dmChatSection').style.display = 'none';
            window.currentDMUser = null;
        }

        // DM を送信
        async function sendDM() {
            if (!window.currentDMUser) return;

            const input = document.getElementById('dmInput');
            const message = input.value.trim();

            if (!message) return;

            const account = Storage.getAccount();
            const dm = await sendDMToGitHub(account.id, window.currentDMUser, message);

            if (dm) {
                input.value = '';
                await openDMChat(window.currentDMUser);
            }
        }

        // DMタブを切り替え
        // DM リストをフィルター（検索）
        function filterDMList() {
            const searchInput = document.getElementById('dmSearchInput');
            const searchQuery = searchInput.value.trim().toLowerCase();
            const dmItems = document.querySelectorAll('.dm-item');
            
            dmItems.forEach(item => {
                const userId = item.querySelector('[style*="font-weight"]').textContent.toLowerCase();
                if (userId.includes(searchQuery) || searchQuery === '') {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // DM リストにフォーカスして常に表示
        function focusDMSearch() {
            document.getElementById('dmSearchInput').focus();
        }

        function switchDMTab(tab) {
            const tabs = document.querySelectorAll('.dm-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function fetchCommentsFromGitHub(postId) {
            try {
                // GitHub から取得を試みる
                const response = await fetch('/.netlify/functions/fetch-comments');
                if (response.ok) {
                    const data = await response.json();
                    const comments = data.comments || [];
                    return comments.filter(c => c.postId === postId);
                }
            } catch (error) {
                // エラーの場合はスキップ
            }
            
            // フォールバック: ローカルストレージからコメントを取得
            const localComments = localStorage.getItem('pulseNetworkComments');
            if (localComments) {
                try {
                    const comments = JSON.parse(localComments);
                    return comments.filter(c => c.postId === postId) || [];
                } catch (e) {
                    return [];
                }
            }
            
            return [];
        }

        // GitHub にコメントを送信
        async function sendCommentToGitHub(postId, text, name) {
            try {
                const response = await fetch('/.netlify/functions/create-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postId: postId,
                        text: text,
                        name: name
                    })
                });

                if (!response.ok) {
                    console.warn('Failed to send comment to GitHub');
                    return null;
                }

                const data = await response.json();
                return data.comment;
            } catch (error) {
                console.warn('Error sending comment to GitHub:', error);
                return null;
            }
        }

        // GitHub からインプレッション数を取得
        async function fetchImpressionsFromGitHub() {
            try {
                const response = await fetch('/.netlify/functions/fetch-impressions');
                if (response.ok) {
                    const data = await response.json();
                    return data.impressions || {};
                }
            } catch (error) {
                console.warn('GitHub impressions fetch failed, using localStorage fallback:', error);
            }
            
            // フォールバック: ローカルストレージから impressions を取得
            try {
                const impressionsJson = localStorage.getItem('twittexImpressions');
                if (impressionsJson) {
                    const impressions = JSON.parse(impressionsJson);
                    console.log(`✓ Loaded impressions from localStorage:`, impressions);
                    return impressions;
                }
            } catch (error) {
                console.error('Failed to load impressions from localStorage:', error);
            }
            
            return {};
        }

        // GitHub にインプレッション数を更新
        async function updateImpressions(postId) {
            try {
                const response = await fetch('/.netlify/functions/update-impressions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postId: postId,
                        increment: 1
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`✓ Impressions updated: ${postId} = ${data.impressions}`);
                    return data.impressions;
                }
            } catch (error) {
                console.warn('GitHub impressions API failed, using localStorage fallback:', error);
            }
            
            // フォールバック: ローカルストレージで impressions を管理
            try {
                const impressionsJson = localStorage.getItem('twittexImpressions');
                const impressions = impressionsJson ? JSON.parse(impressionsJson) : {};
                
                // 現在のインプレッション数を取得
                impressions[postId] = (impressions[postId] || 0) + 1;
                
                // ローカルストレージに保存
                localStorage.setItem('twittexImpressions', JSON.stringify(impressions));
                
                console.log(`✓ Impressions saved to localStorage: ${postId} = ${impressions[postId]}`);
                return impressions[postId];
            } catch (error) {
                console.error('Failed to update impressions:', error);
            }
            
            return null;
        }

        // アナリティクスイベントをトラッキング
        async function trackEvent(eventName, eventData) {
            try {
                const account = Storage.getAccount();
                
                const response = await fetch('/.netlify/functions/track-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event: eventName,
                        userId: account.id,
                        data: {
                            postId: eventData,
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent
                        }
                    })
                });

                if (!response.ok) {
                    console.warn('Failed to track event:', eventName);
                    return false;
                }

                const result = await response.json();
                console.log(`✓ Event tracked: ${eventName}`, result.eventId);
                return true;
            } catch (error) {
                console.error('Error tracking event:', error);
                return false;
            }
        }

        // すべてのコメントを読み込んで表示
        async function loadAndDisplayComments(posts) {
            if (!posts || posts.length === 0) return;
            
            for (const post of posts) {
                try {
                    const comments = await fetchCommentsFromGitHub(post.id);
                    const commentsContainer = document.getElementById(`comments-${post.id}`);
                    
                    if (commentsContainer && comments && comments.length > 0) {
                        let commentsHTML = '';
                        
                        comments.forEach(comment => {
                            commentsHTML += `
                                <div style="padding: 8px 12px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 4px; border-left: 2px solid var(--primary);">
                                    <div style="font-weight: 600; font-size: 12px; color: var(--text-primary);">${comment.name || 'Anonymous'}</div>
                                    <div style="font-size: 12px; margin-top: 4px; color: var(--text-primary);">${comment.text || ''}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                                        ${comment.createdAt ? formatTime(comment.createdAt) : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        commentsContainer.innerHTML = commentsHTML;
                    }
                } catch (error) {
                    // 個別のエラーはスキップして続行
                    console.warn(`Error loading comments for post ${post.id}:`, error);
                }
            }
        }

        async function renderFeed(feed, posts, rooms) {
            let html = '';
            
            // インプレッション数を取得
            const impressions = await fetchImpressionsFromGitHub();

            // 5. Native Banner Ad - トップに配置
            html += `<div style="padding: 12px; text-align: center; background: rgba(29, 155, 240, 0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px;">
                <div id="container-c450e9b4b86a15429281d6d1bb83b6f2" style="min-height: 50px;"></div>
            </div>`;

            rooms.forEach(room => {
                const messages = (room.messages || []).length;
                html += `
                    <div class="post-card" onclick="openYouTubeWatchModal(${JSON.stringify(room).replace(/"/g, '&quot;')})">
                        <div class="post-header">
                            <div class="post-avatar">▶</div>
                            <div class="post-info">
                                <div class="post-meta">
                                    <span class="post-name">${room.title}</span>
                                    <span class="post-time">${formatTime(room.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">YouTube Room | Messages: ${messages} | Queue: ${(room.queue || []).length}</div>
                        <div class="post-actions">
                            <div class="action-item">Join</div>
                            <div class="action-item">Share</div>
                        </div>
                    </div>
                `;
            });

            posts.forEach((post, index) => {
                // 5投稿ごとに SmartLink 広告を挿入
                if (index > 0 && index % 5 === 0) {
                    html += `
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(29, 155, 240, 0.1), rgba(0, 217, 255, 0.05)); border: 1px dashed var(--border); border-radius: 8px; margin: 16px 0; text-align: center;">
                            <a href="https://engagementidentifiers.com/qst8wwse?key=385ee7d478d037878c615a8416a3507a" target="_blank" rel="noopener noreferrer" style="text-decoration: none; display: inline-block;">
                                <div style="color: var(--primary); font-weight: 600; font-size: 13px; padding: 8px 12px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 8px rgba(29, 155, 240, 0.3)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                    🎁 Special Offer - Click Here →
                                </div>
                            </a>
                        </div>
                    `;
                }

                let mediaHTML = '';

                // 画像表示
                if (post.images && post.images.length > 0) {
                    mediaHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 12px;">`;
                    post.images.forEach(img => {
                        // img は以下の形式:
                        // 1. URL 文字列: "data/images/123_abc.jpg"
                        // 2. オブジェクト: { url: "data/images/123_abc.jpg" }
                        // 3. Base64: "data:image/jpeg;base64,..."
                        let imageSource = '';
                        
                        if (typeof img === 'string') {
                            imageSource = img;
                        } else if (img.url) {
                            imageSource = img.url;
                        } else if (img.data) {
                            imageSource = img.data;
                        }
                        
                        // data/images/... パスの場合、GitHub Raw URL に変換
                        if (imageSource && imageSource.startsWith('data/images/')) {
                            imageSource = `https://raw.githubusercontent.com/ROBA12551/data/main/${imageSource}`;
                        }
                        
                        mediaHTML += `<img src="${imageSource}" alt="post image" style="border-radius: 8px; max-width: 100%; height: auto;" onerror="this.style.display='none'">`;
                    });
                    mediaHTML += `</div>`;
                }

                // URL プレビュー表示
                if (post.urls && post.urls.length > 0) {
                    post.urls.forEach(url => {
                        // URLオブジェクトまたは文字列の両方に対応
                        const urlData = typeof url === 'string' ? { url: url } : url;
                        mediaHTML += `
                            <a href="${urlData.url}" target="_blank" style="text-decoration: none;">
                                <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" onmouseout="this.style.backgroundColor='var(--bg-secondary)'">
                                    <div style="display: flex; gap: 12px;">
                                        ${urlData.image ? `
                                            <div style="width: 100px; height: 80px; border-radius: 6px; overflow: hidden; background: var(--bg-primary); flex-shrink: 0;">
                                                <img src="${urlData.image}" alt="preview" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">
                                            </div>
                                        ` : ''}
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${urlData.title || 'Link'}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${urlData.description || ''}</div>
                                            <div style="font-size: 11px; color: var(--primary);">${urlData.domain || new URL(urlData.url).hostname}</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        `;
                    });
                }

                html += `
                    <div class="post-card" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="post-avatar">${post.displayName.charAt(0).toUpperCase()}</div>
                            <div class="post-info">
                                <div class="post-meta">
                                    <span class="post-name">${post.displayName}</span>
                                    <span class="post-id">${post.anonymousId}</span>
                                    <span class="post-time">${formatTime(post.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        ${post.hashtags && post.hashtags.length > 0 ? `
                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                                ${post.hashtags.map(tag => `
                                    <span style="padding: 4px 10px; background: rgba(29, 155, 240, 0.1); border-radius: 16px; font-size: 12px; color: var(--primary); cursor: pointer;" onclick="filterByHashtag('${tag}')">#${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${mediaHTML}
                        <div class="post-actions">
                            <div class="action-item" onclick="event.stopPropagation(); updateImpressions('${post.id}').then(() => location.reload()); trackEvent('page_view', '${post.id}');">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                <span>${impressions[post.id] || 0}</span>
                            </div>
                            <div class="action-item" onclick="event.stopPropagation(); openCommentsModal('${post.id}', '${post.creatorName}'); trackEvent('post_engagement', '${post.id}');">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span>${post.engagementCount?.replies || 0}</span>
                            </div>
                            <div class="action-item" onclick="event.stopPropagation(); copyPostLink('${post.id}');">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                <span>Copy</span>
                            </div>
                        </div>
                    </div>
                `;

                // コメント表示用のコンテナ（非表示 - モーダルで表示）
                html += `<div id="comments-${post.id}" style="margin-top: 8px; padding-left: 12px; border-left: 2px solid var(--primary); display: none;"></div>`;

                // 投稿が10個以上ある場合、10個ごとに広告を表示
                if (posts.length >= 10 && (index + 1) % 10 === 0) {
                    // 広告は表示しない（削除）
                }
            });

            feed.innerHTML = html;

            // コメントを非同期で読み込んで表示
            loadAndDisplayComments(posts);
        }

        // トレンディング表示用の時間範囲
        let trendingTimeRange = 24; // デフォルト24時間

        function loadTrending() {
            const posts = Storage.getPosts();
            const trendingPosts = twittexAlgorithm.getTrendingPosts(posts, trendingTimeRange, 10);

            const trendingPostsContainer = document.getElementById('trendingPosts');
            if (trendingPosts.length === 0) {
                trendingPostsContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 12px; text-align: center;">No trending posts</div>';
            } else {
                trendingPostsContainer.innerHTML = trendingPosts.map((post, idx) => `
                    <div class="trend-item" style="cursor: pointer;" onclick="scrollToPost('${post.id}')">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">#${idx + 1}</div>
                            <div class="trend-title">${post.displayName}</div>
                        </div>
                        <div class="trend-meta">${post.content.substring(0, 60)}${post.content.length > 60 ? '...' : ''}</div>
                        <div class="trend-count">👁 ${post.views || 0} views | 💬 ${post.engagementCount?.replies || 0} replies</div>
                    </div>
                `).join('');
            }

            const rooms = Storage.getYouTubeRooms();
            const sortedRooms = [...rooms].sort((a, b) => 
                (b.messages?.length || 0) - (a.messages?.length || 0)
            ).slice(0, 5);

            const trendingYouTubeContainer = document.getElementById('trendingYouTube');
            if (sortedRooms.length === 0) {
                trendingYouTubeContainer.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); font-size: 12px; text-align: center;">No rooms yet</div>';
            } else {
                trendingYouTubeContainer.innerHTML = sortedRooms.map(room => `
                    <div class="trend-item" onclick="openYouTubeWatchModal(${JSON.stringify(room).replace(/"/g, '&quot;')})">
                        <div class="trend-title">${room.title}</div>
                        <div class="trend-meta">by ${room.createdAt.split('T')[0]}</div>
                        <div class="trend-count">💬 ${(room.messages || []).length} messages</div>
                    </div>
                `).join('');
            }
        }

        // トレンディング投稿にスクロール
        function scrollToPost(postId) {
            const post = document.querySelector(`[data-post-id="${postId}"]`);
            if (post) {
                post.scrollIntoView({ behavior: 'smooth', block: 'center' });
                post.style.backgroundColor = 'rgba(29, 155, 240, 0.1)';
                setTimeout(() => {
                    post.style.backgroundColor = 'transparent';
                }, 1500);
            }
        }

        // トレンディング時間範囲を変更
        function setTrendingTimeRange(hours) {
            trendingTimeRange = hours;
            loadTrending();
        }

        function switchTab(tab) {
            document.getElementById('tabTitle').textContent = 
                tab === 'feed' ? t('home') : t('search');
        }

        // ログアウト確認ダイアログ
        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        }

        function logout() {
            // すべてのローカルストレージデータを削除
            const keysToRemove = [
                'pulseAccount',
                'pulseNetworkPosts',
                'pulseNetworkComments',
                'pulseNetworkThreads',
                'pulseNetworkQA',
                'pulseNetworkAnalytics',
                'pulseNetworkRooms',
                'pulseNetworkTrending',
                'pulseNetworkHashtags',
                'pulseNetworkNotifications',
                'twittexDMs'
            ];

            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });

            // または全削除したい場合:
            // localStorage.clear();

            console.log('✓ All user data cleared');
            location.reload();
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString();
        }

        let composeImages = [];
        let composeURL = null;

        function openComposeModal() {
            const account = Storage.getAccount();
            const modal = document.getElementById('composeModal');
            
            document.getElementById('composeAvatar').textContent = account.avatar;
            document.getElementById('composeName').textContent = account.name;
            document.getElementById('composeId').textContent = account.id;
            document.getElementById('composeTextarea').value = '';
            
            composeImages = [];
            composeURL = null;
            document.getElementById('composeMediaPreview').innerHTML = '';
            document.getElementById('composeURLPreview').innerHTML = '';
            
            modal.classList.add('open');
            document.getElementById('composeTextarea').focus();
        }

        function closeComposeModal() {
            document.getElementById('composeModal').classList.remove('open');
            document.getElementById('composeTextarea').value = '';
            document.getElementById('composeHashtags').value = '';
            composeImages = [];
            composeURL = null;
            document.getElementById('composeMediaPreview').innerHTML = '';
            document.getElementById('composeURLPreview').innerHTML = '';
        }

        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            const maxImages = 5 - composeImages.length;

            files.slice(0, maxImages).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    composeImages.push({
                        data: e.target.result,
                        file: file,
                        name: file.name
                    });
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            });

            // リセット
            document.getElementById('composeImageInput').value = '';
        }

        function renderImagePreview() {
            const preview = document.getElementById('composeMediaPreview');
            preview.innerHTML = composeImages.map((img, idx) => `
                <div class="compose-image-item">
                    <img src="${img.data}" alt="preview">
                    <button class="compose-image-remove" onclick="removeImage(${idx})">×</button>
                </div>
            `).join('');
        }

        function removeImage(idx) {
            composeImages.splice(idx, 1);
            renderImagePreview();
        }

        function openURLModal() {
            document.getElementById('urlModal').classList.add('open');
            document.getElementById('urlInput').focus();
        }

        function closeURLModal() {
            document.getElementById('urlModal').classList.remove('open');
            document.getElementById('urlInput').value = '';
        }

        async function fetchURLPreview() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                showNotification('Error', 'Please enter a URL');
                return;
            }

            // URL バリデーション
            try {
                new URL(url);
            } catch (error) {
                showNotification('Error', 'Invalid URL format');
                return;
            }

            try {
                // メタデータをフェッチ（CORS エラーは予想される）
                let metadata = {
                    url: url,
                    title: 'Link',
                    description: 'Click to visit',
                    image: null,
                    domain: new URL(url).hostname
                };

                // メタデータ取得を試みる（失敗しても続行）
                try {
                    const response = await fetch(url, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    // no-cors では HTML を取得できないので、ドメイン情報のみ
                    console.log('✓ URL is accessible:', url);
                } catch (corsError) {
                    console.warn('⚠️ CORS or connectivity issue (expected):', corsError.message);
                    // CORS エラーは予想される - 基本情報で続行
                }

                // 基本情報をセット
                composeURL = metadata;
                renderURLPreview();
                closeURLModal();
                showNotification('Success', 'URL added to post');
            } catch (error) {
                console.warn('❌ URL preview fetch failed:', error.message);
                // エラーでも URL を追加
                composeURL = {
                    url: url,
                    title: 'Link',
                    description: url,
                    image: null,
                    domain: new URL(url).hostname
                };
                renderURLPreview();
                closeURLModal();
                showNotification('Success', 'URL added (preview unavailable)');
            }
        }

        function renderURLPreview() {
            const preview = document.getElementById('composeURLPreview');
            if (!composeURL) {
                preview.innerHTML = '';
                return;
            }

            preview.innerHTML = `
                <div class="compose-url-preview" style="position: relative;">
                    <div class="compose-url-preview-card">
                        ${composeURL.image ? `
                            <div class="compose-url-preview-image">
                                <img src="${composeURL.image}" alt="preview" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        <div class="compose-url-preview-content">
                            <div class="compose-url-preview-title">${composeURL.title}</div>
                            <div class="compose-url-preview-desc">${composeURL.description}</div>
                            <div class="compose-url-preview-domain">${composeURL.domain}</div>
                        </div>
                    </div>
                    <button class="compose-url-remove" onclick="removeURL()">×</button>
                </div>
            `;
        }

        function removeURL() {
            composeURL = null;
            document.getElementById('composeURLPreview').innerHTML = '';
        }

        function postCompose() {
            const content = document.getElementById('composeTextarea').value.trim();
            const hashtagsInput = document.getElementById('composeHashtags').value.trim();
            const account = Storage.getAccount();

            if (!content && composeImages.length === 0 && !composeURL) {
                showNotification('Error', 'Please enter some text or add media');
                return;
            }

            // 重複投稿をチェック
            const allPosts = Storage.getPosts();
            if (twittexAlgorithm.detectDuplicate(content, allPosts)) {
                showNotification('Error', 'This post is too similar to an existing post. Please modify your content.');
                return;
            }

            // スパム判定をチェック
            const spamCheck = twittexAlgorithm.detectSpam(account.id, allPosts);
            if (spamCheck.isSpam) {
                showNotification('Error', `Too many posts in a short time. Please wait before posting again. (${spamCheck.recentPostCount}/${spamCheck.maxAllowed})`);
                return;
            }

            // ハッシュタグを処理
            const hashtags = hashtagsInput
                .split(/\s+/)
                .map(tag => tag.replace(/^#/, '').toLowerCase())
                .filter(tag => tag.length > 0);

            const post = {
                id: `post_${Date.now()}`,
                displayName: account.name,
                anonymousId: account.id,
                content: content,
                images: [],  // 画像なし
                urls: composeURL ? [composeURL.url || composeURL] : [],  // ✅ URL 文字列のみ
                hashtags: hashtags,
                createdAt: new Date().toISOString(),
                views: 0,
                engagementCount: { replies: 0, shares: 0 }
            };

            // LocalStorageに保存
            Storage.addPost(post);
            console.log('✓ Post saved to localStorage:', post.id);
            
            // ハッシュタグをグローバルリストに追加
            addHashtagsToGlobal(hashtags);
            
            // クリアして UI リセット
            document.getElementById('composeTextarea').value = '';
            document.getElementById('composeHashtags').value = '';
            composeImages = [];
            composeURL = null;
            
            // ローカル保存完了を通知（GitHub 同期は別途実行）
            showNotification('Success', 'Post created! 📤');
            closeComposeModal();
            
            // フィードを更新
            loadFeed();
            loadTrending();
            
            // GitHub APIに投稿を送信（非同期・バックグラウンド）
            sendPostToGitHub(post).then(success => {
                if (success) {
                    console.log('✓ Post synced to GitHub');
                } else {
                    console.log('⚠️ Post saved locally (GitHub sync pending)');
                }
            }).catch(err => {
                console.warn('⚠️ GitHub sync failed:', err.message);
            });
        }

        // 投稿クリック時にビュー数を増加させ、イベントをトラッキング
        function trackPostView(postId) {
            trackEvent('page_view', postId);
            
            // ローカルのビュー数を増加
            const posts = Storage.getPosts();
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.views = (post.views || 0) + 1;
                const idx = posts.findIndex(p => p.id === postId);
                if (idx >= 0) {
                    posts[idx] = post;
                    localStorage.setItem('pulseNetworkPosts', JSON.stringify(posts));
                }
            }
        }

        async function sendPostToGitHub(post) {
            try {
                // 画像をアップロード（存在する場合のみ）
                let uploadedImages = [];
                if (post.images && post.images.length > 0) {
                    console.log(`⏳ Uploading ${post.images.length} image(s)...`);
                    for (const img of post.images) {
                        try {
                            const imageUrl = await uploadImageToGitHub(img, post.anonymousId);
                            if (imageUrl) {
                                // imageUrl は "data/images/123_abc.jpg" 形式
                                uploadedImages.push(imageUrl);
                            }
                        } catch (imgError) {
                            console.warn('⚠️ Image upload failed, continuing without image:', imgError.message);
                        }
                    }
                }

                // 投稿データを準備（画像URLを含める）
                // URLs を文字列配列に正規化
                let urls = [];
                if (post.urls && post.urls.length > 0) {
                    if (typeof post.urls[0] === 'string') {
                        urls = post.urls;
                    } else {
                        // オブジェクト形式の場合（例：{ url: "...", title: "..." }）
                        urls = post.urls.map(u => {
                            if (typeof u === 'string') return u;
                            if (u.url) return u.url;
                            return u;
                        }).filter(u => u && typeof u === 'string');
                    }
                }

                const postData = {
                    id: post.id,
                    displayName: post.displayName,
                    anonymousId: post.anonymousId,
                    content: post.content,
                    images: uploadedImages,  // ← "data/images/..." 形式の URL 配列
                    urls: urls,  // ✅ 文字列配列のみ
                    hashtags: post.hashtags || [],
                    createdAt: post.createdAt,
                    views: post.views || 0,
                    engagementCount: post.engagementCount || { replies: 0, shares: 0 }
                };

                console.log('📋 Post data to send:', {
                    hasContent: !!postData.content,
                    contentLength: postData.content?.length,
                    urls: postData.urls,
                    urlsLength: postData.urls?.length,
                    images: postData.images.length,
                    hashtags: postData.hashtags,
                    anonymousId: postData.anonymousId
                });

                // JSON がシリアライズできるか確認
                try {
                    const jsonStr = JSON.stringify(postData);
                    console.log('✅ JSON serialization successful, size:', jsonStr.length);
                } catch (e) {
                    console.error('❌ JSON serialization failed:', e.message);
                    throw e;
                }

                // Netlify Functionに投稿を送信
                console.log('📤 Sending post to GitHub...');
                const response = await fetch('/.netlify/functions/create-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (!response.ok) {
                    try {
                        const errorData = await response.json();
                        console.error('❌ Error sending post to GitHub:', errorData);
                    } catch (e) {
                        console.error('❌ Error sending post (status:', response.status + ')');
                    }
                    // エラーでも localStorage には保存されているので通知のみ
                    console.log('✓ Post saved locally (GitHub sync failed)');
                    return false;
                }

                const result = await response.json();
                console.log('✓ Post saved to GitHub:', result.post?.id || 'unknown');
                return true;
            } catch (error) {
                console.warn('⚠️ GitHub sync error (post is saved locally):', error.message);
                // localStorage には既に保存されているので、エラーでも継続
                return false;
            }
        }

        // 画像をGitHub APIにアップロード
        async function uploadImageToGitHub(imageData, anonymousId) {
            try {
                // Base64画像データを処理
                if (!imageData.data) {
                    throw new Error('Invalid image data');
                }

                const base64Data = imageData.data;
                
                console.log('⏳ Uploading image:', imageData.name);
                
                // save-image Netlify Function に送信
                // GitHub data フォルダに画像を保存
                const response = await fetch('/.netlify/functions/save-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        anonymousId: anonymousId || 'anonymous',
                        data: base64Data,
                        fileName: imageData.name || 'image.jpg'
                    })
                });

                if (!response.ok) {
                    try {
                        const errorData = await response.json();
                        console.error('❌ Image upload error:', errorData);
                        throw new Error(errorData.error || `Upload failed: ${response.status}`);
                    } catch (e) {
                        console.error('❌ Image upload error (status:', response.status + ')');
                        throw e;
                    }
                }

                const result = await response.json();
                const imageUrl = result.image?.url || result.url || null;
                if (imageUrl) {
                    console.log('✓ Image uploaded:', imageUrl);
                }
                return imageUrl;
            } catch (error) {
                console.warn('⚠️ Image upload skipped:', error.message);
                // 画像アップロード失敗でも投稿は続行
                return null;
            }
        }

        function addHashtagsToGlobal(hashtags) {
            const allHashtags = JSON.parse(localStorage.getItem('allHashtags') || '{}');
            
            hashtags.forEach(tag => {
                if (!allHashtags[tag]) {
                    allHashtags[tag] = {
                        name: tag,
                        count: 0,
                        createdAt: new Date().toISOString()
                    };
                }
                allHashtags[tag].count++;
            });
            
            localStorage.setItem('allHashtags', JSON.stringify(allHashtags));
        }

        function getHashtagsForSearch() {
            return JSON.parse(localStorage.getItem('allHashtags') || '{}');
        }

        function searchByHashtag(hashtag) {
            const posts = Storage.getPosts();
            const cleanTag = hashtag.replace(/^#/, '').toLowerCase();
            
            const filteredPosts = posts.filter(post => 
                post.hashtags && post.hashtags.includes(cleanTag)
            );
            
            return filteredPosts;
        }

        init();
    </script>

    <!-- DM Modal -->
    <div id="dmModal" class="ai-modal" onclick="if(event.target === this) closeDMModal()">
        <div class="ai-modal-content">
            <div class="ai-modal-header" style="display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--bg-primary);">
                <button onclick="closeDMModal()" class="close-btn" style="background:none; border:none; color:var(--text-secondary); font-size:24px; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">✕</button>
                <div class="modal-title" style="font-size:18px; color:var(--text-primary); margin:0; font-weight:600;">Messages</div>
                <div style="width:32px;"></div>
            </div>
            
            <div class="dm-container" style="display:flex; height:600px; max-height:80vh;">
                <!-- DM リスト -->
                <div class="dm-list-section" id="dmListSection" style="width:100%; border-right:1px solid var(--border); overflow-y:auto;">
                    <div class="dm-search" style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:center;">
                        <input type="text" id="dmSearchInput" placeholder="Search ID..." style="width:33%; padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary); font-size:14px;" onkeyup="filterDMList()">
                    </div>
                    
                    <div class="dm-tabs" style="display:flex; padding:8px 12px; border-bottom:1px solid var(--border); gap:8px;">
                        <button class="dm-tab active" onclick="switchDMTab('all')" style="padding:6px 12px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">All</button>
                        <button class="dm-tab" onclick="switchDMTab('unread')" style="padding:6px 12px; background:transparent; color:var(--text-secondary); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:13px;">Unread</button>
                    </div>
                    
                    <div id="dmList" class="dm-list" style="padding:12px;">
                        <div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                            <div style="font-size:48px; margin-bottom:12px;">✉️</div>
                            <div>No messages yet</div>
                            <div style="font-size:12px; margin-top:8px;">Send someone a message to get started</div>
                        </div>
                    </div>
                </div>
                
                <!-- DM チャット -->
                <div class="dm-chat-section" id="dmChatSection" style="display:none; width:100%; flex-direction:column; background:var(--bg-primary);">
                    <div class="dm-chat-header" style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--bg-secondary);">
                        <button onclick="backToDMList()" style="background:none; border:none; color:var(--primary); font-size:20px; cursor:pointer;">←</button>
                        <div class="dm-chat-user" id="dmChatUser" style="font-weight:600;">Select a user</div>
                        <div></div>
                    </div>
                    
                    <div id="dmMessages" class="dm-messages" style="flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px;"></div>
                    
                    <div style="padding:12px; display:flex; gap:8px; border-top:1px solid var(--border); background:var(--bg-secondary);">
                        <input type="text" id="dmInput" placeholder="Type a message..." style="flex:1; padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg-primary); color:var(--text-primary);">
                        <button onclick="sendDM()" style="padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <div class="bottom-nav" id="bottomNav">
        <button class="bottom-nav-item active" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); switchTab('feed'); updateBottomNav('feed');" title="Home">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M3 12h2v9H3zM7 9h2v12H7zM11 6h2v15h-2zM15 3h2v18h-2zM19 5h2v16h-2z" fill="white"/>
            </svg>
        </button>
        <button class="bottom-nav-item" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); openSearchModal(); updateBottomNav('search');" title="Search">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </button>
        <button class="bottom-nav-item" onclick="closeCommentsModal(); closeDMModal(); closeAIModalAuto(); openNotificationModal(); updateBottomNav('notifications');" title="Notifications">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        </button>
        <button class="bottom-nav-item" onclick="closeCommentsModal(); closeDMModal(); openAIModal(); updateBottomNav('gsh');" title="Gsh">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>
            </svg>
        </button>
        <button class="bottom-nav-item" onclick="closeCommentsModal(); closeAIModalAuto(); openDMModal(); updateBottomNav('dm');" title="Messages">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M20 10c0-5.52-4.48-10-10-10S0 4.48 0 10c0 4.84 3.46 8.87 8 9.8V23l5-3c5.16-.92 9-5.04 9-9.8z"></path>
            </svg>
        </button>
        <button class="bottom-nav-item" onclick="confirmLogout();" title="Logout">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"></path>
            </svg>
        </button>
    </div>

    <script>
        // Bottom Navigation Controller
        function updateBottomNav(activeTab) {
            if (window.innerWidth <= 768) {
                const buttons = document.querySelectorAll('.bottom-nav-item');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                const tabMap = {
                    'feed': 0,
                    'search': 1,
                    'notifications': 2,
                    'gsh': 3,
                    'dm': 4,
                    'qa': 5
                };
                
                if (tabMap[activeTab] !== undefined) {
                    buttons[tabMap[activeTab]].classList.add('active');
                }
            }
        }

        // Update bottom nav on initial load
        window.addEventListener('load', () => {
            if (window.innerWidth <= 768) {
                updateBottomNav('feed');
            }
        });
    </script>
</body>
</html>