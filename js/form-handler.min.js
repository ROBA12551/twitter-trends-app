/**
 * お問い合わせフォームハンドラー
 * 最適化版 - 軽量・高速・アクセシブル
 */

(function() {
  'use strict';
  
  // DOM読み込み完了
  document.addEventListener('DOMContentLoaded', function() {
    initFormHandler();
    initAccessibility();
    initAdPlaceholders();
  });
  
  /**
   * フォームハンドラーの初期化
   */
  function initFormHandler() {
    const reportForm = document.getElementById('reportForm');
    const imageUpload = document.getElementById('imageUpload');
    const fileList = document.getElementById('fileList');
    const alertElement = document.getElementById('alert');
    let uploadedFiles = [];
    
    if (!reportForm) return;
    
    // ファイルアップロード処理
    if (imageUpload) {
      imageUpload.addEventListener('change', handleFileUpload);
      
      // ドラッグ＆ドロップサポート
      const uploadLabel = document.querySelector('.file-upload-label');
      if (uploadLabel) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadLabel.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragover'].forEach(eventName => {
          uploadLabel.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          uploadLabel.addEventListener(eventName, unhighlight, false);
        });
        
        uploadLabel.addEventListener('drop', handleDrop, false);
      }
    }
    
    /**
     * ファイルアップロード処理
     */
    function handleFileUpload(e) {
      const files = Array.from(e.target.files);
      uploadedFiles = [];
      fileList.innerHTML = '';
      
      if (files.length === 0) {
        fileList.style.display = 'none';
        return;
      }
      
      files.forEach((file, index) => {
        // ファイルサイズチェック（5MB）
        if (file.size > 5 * 1024 * 1024) {
          showAlert(`ファイル「${file.name}」は5MBを超えています`, 'error');
          return;
        }
        
        // ファイル形式チェック
        if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) {
          showAlert(`ファイル「${file.name}」はサポートされていない形式です`, 'error');
          return;
        }
        
        uploadedFiles.push(file);
        
        // ファイルアイテムを追加
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
          <button type="button" class="file-remove" data-index="${uploadedFiles.length - 1}" aria-label="このファイルを削除">
            削除
          </button>
        `;
        fileList.appendChild(fileItem);
      });
      
      fileList.style.display = uploadedFiles.length > 0 ? 'block' : 'none';
      
      // 削除ボタンにイベントリスナーを追加
      fileList.querySelectorAll('.file-remove').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          removeFile(index);
        });
      });
    }
    
    /**
     * ファイル削除
     */
    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      imageUpload.value = '';
      
      if (uploadedFiles.length === 0) {
        fileList.style.display = 'none';
        fileList.innerHTML = '';
      } else {
        // ファイルリストを更新
        fileList.innerHTML = '';
        uploadedFiles.forEach((file, idx) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
            <button type="button" class="file-remove" data-index="${idx}" aria-label="このファイルを削除">
              削除
            </button>
          `;
          fileList.appendChild(fileItem);
        });
        
        // 削除ボタンにイベントリスナーを再追加
        fileList.querySelectorAll('.file-remove').forEach(button => {
          button.addEventListener('click', function() {
            const idx = parseInt(this.dataset.index);
            removeFile(idx);
          });
        });
      }
    }
    
    /**
     * ドラッグ＆ドロップヘルパー関数
     */
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight() {
      document.querySelector('.file-upload-label').style.backgroundColor = '#f0f0f0';
      document.querySelector('.file-upload-label').style.borderColor = 'var(--primary)';
    }
    
    function unhighlight() {
      document.querySelector('.file-upload-label').style.backgroundColor = '';
      document.querySelector('.file-upload-label').style.borderColor = '';
    }
    
    function handleDrop(e) {
      const files = e.dataTransfer.files;
      imageUpload.files = files;
      const event = new Event('change', { bubbles: true });
      imageUpload.dispatchEvent(event);
    }
    
    /**
     * フォーム送信処理
     */
    reportForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.querySelector('.btn-text').textContent;
      
      // ボタン状態を更新
      submitBtn.disabled = true;
      submitBtn.querySelector('.btn-text').innerHTML = `
        <span class="spinner" aria-hidden="true"></span>送信中...
      `;
      
      try {
        // フォームデータを取得
        const formData = {
          reportType: document.getElementById('reportType').value,
          contentUrl: document.getElementById('contentUrl').value,
          description: document.getElementById('description').value,
          email: document.getElementById('email').value,
          reporterName: document.getElementById('reporterName').value,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          referrer: document.referrer
        };
        
        // バリデーション
        if (!validateForm(formData)) {
          throw new Error('フォームの入力内容に問題があります');
        }
        
        // スパム防止（クライアントサイド簡易チェック）
        if (!checkSpamProtection()) {
          throw new Error('送信頻度が高すぎます。しばらくお待ちください');
        }
        
        // Discord Webhookに送信
        const webhookPayload = {
          content: '**新しい報告が送信されました**',
          embeds: [{
            title: `報告の種類: ${getReportTypeLabel(formData.reportType)}`,
            description: formData.description,
            fields: [
              {
                name: 'コンテンツURL',
                value: formData.contentUrl || '未提供',
                inline: false
              },
              {
                name: 'メールアドレス',
                value: formData.email || '未提供',
                inline: true
              },
              {
                name: '報告者名',
                value: formData.reporterName || '匿名',
                inline: true
              },
              {
                name: 'ユーザーエージェント',
                value: formData.userAgent.substring(0, 100) + '...',
                inline: false
              },
              {
                name: '報告日時',
                value: new Date().toLocaleString('ja-JP'),
                inline: false
              }
            ],
            color: 16711680,
            timestamp: formData.timestamp
          }]
        };
        
        // Netlify Functionを使用してDiscordに送信
        const response = await fetch('/.netlify/functions/send-report', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Protection': '1'
          },
          body: JSON.stringify(webhookPayload)
        });
        
        if (!response.ok) {
          throw new Error('報告の送信に失敗しました');
        }
        
        // 成功処理
        showAlert('報告を正常に送信しました。ご協力ありがとうございます！', 'success');
        
        // フォームをリセット
        reportForm.reset();
        fileList.style.display = 'none';
        fileList.innerHTML = '';
        uploadedFiles = [];
        
        // 送信履歴を記録
        recordSubmission();
        
        // 成功メッセージ後にフォームの最初のフィールドにフォーカス
        setTimeout(() => {
          document.getElementById('reportType').focus();
        }, 1000);
        
      } catch (error) {
        console.error('フォーム送信エラー:', error);
        showAlert(`エラー: ${error.message}`, 'error');
      } finally {
        // ボタン状態を元に戻す
        submitBtn.disabled = false;
        submitBtn.querySelector('.btn-text').textContent = originalText;
      }
    });
    
    /**
     * フォームバリデーション
     */
    function validateForm(data) {
      if (!data.reportType) {
        showAlert('報告の種類を選択してください', 'error');
        document.getElementById('reportType').focus();
        return false;
      }
      
      if (!data.description.trim()) {
        showAlert('詳細説明を入力してください', 'error');
        document.getElementById('description').focus();
        return false;
      }
      
      if (data.contentUrl && !isValidUrl(data.contentUrl)) {
        showAlert('有効なURLを入力してください', 'error');
        document.getElementById('contentUrl').focus();
        return false;
      }
      
      if (data.email && !isValidEmail(data.email)) {
        showAlert('有効なメールアドレスを入力してください', 'error');
        document.getElementById('email').focus();
        return false;
      }
      
      return true;
    }
    
    /**
     * スパム防止チェック
     */
    function checkSpamProtection() {
      const storageKey = 'lastReportSubmission';
      const cooldownPeriod = 60000; // 60秒
      
      try {
        const lastSubmission = localStorage.getItem(storageKey);
        if (lastSubmission) {
          const lastTime = new Date(lastSubmission).getTime();
          const now = new Date().getTime();
          
          if (now - lastTime < cooldownPeriod) {
            return false;
          }
        }
        return true;
      } catch (e) {
        // localStorageが利用できない場合
        return true;
      }
    }
    
    /**
     * 送信履歴を記録
     */
    function recordSubmission() {
      const storageKey = 'lastReportSubmission';
      try {
        localStorage.setItem(storageKey, new Date().toISOString());
      } catch (e) {
        // localStorageが利用できない場合は無視
      }
    }
    
    /**
     * 報告種類のラベルを取得
     */
    function getReportTypeLabel(type) {
      const labels = {
        'inappropriate-content': '不適切なコンテンツ',
        'copyright': '著作権侵害',
        'spam': 'スパム',
        'illegal': '違法コンテンツ',
        'bug': 'バグ報告',
        'other': 'その他'
      };
      return labels[type] || type;
    }
    
    /**
     * URLバリデーション
     */
    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }
    
    /**
     * メールアドレスバリデーション
     */
    function isValidEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    /**
     * アラート表示
     */
    function showAlert(message, type = 'success') {
      if (!alertElement) return;
      
      // 既存のアラートをクリア
      alertElement.className = 'alert';
      alertElement.textContent = '';
      alertElement.setAttribute('aria-hidden', 'true');
      
      // 新しいアラートを設定
      alertElement.classList.add(`alert--${type}`);
      alertElement.textContent = message;
      alertElement.setAttribute('aria-hidden', 'false');
      
      // スクリーンリーダーに通知
      alertElement.setAttribute('role', 'alert');
      
      // 自動で非表示にする
      setTimeout(() => {
        alertElement.setAttribute('aria-hidden', 'true');
        alertElement.className = 'alert';
      }, 5000);
      
      // フォーカスを移動
      alertElement.focus();
    }
  }
  
  /**
   * アクセシビリティ機能の初期化
   */
  function initAccessibility() {
    // キーボードナビゲーションの改善
    document.addEventListener('keydown', function(e) {
      // Escapeキーでモーダルを閉じるなど
      if (e.key === 'Escape') {
        const alert = document.getElementById('alert');
        if (alert && alert.getAttribute('aria-hidden') === 'false') {
          alert.setAttribute('aria-hidden', 'true');
          alert.className = 'alert';
        }
      }
    });
    
    // フォーカス表示の改善
    const style = document.createElement('style');
    style.textContent = `
      :focus {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
      }
      
      :focus:not(:focus-visible) {
        outline: none;
      }
      
      :focus-visible {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
      }
    `;
    document.head.appendChild(style);
  }
  
  /**
   * 広告プレースホルダーの初期化
   */
  function initAdPlaceholders() {
    // 広告の遅延読み込み監視
    const adPlaceholders = document.querySelectorAll('.ad-placeholder');
    
    if ('IntersectionObserver' in window) {
      const adObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const adElement = entry.target;
            // 広告スクリプトのロードをトリガー
            loadAdScripts(adElement);
            adObserver.unobserve(adElement);
          }
        });
      }, {
        rootMargin: '100px',
        threshold: 0.1
      });
      
      adPlaceholders.forEach(placeholder => {
        adObserver.observe(placeholder);
      });
    } else {
      // Fallback for older browsers
      setTimeout(() => {
        adPlaceholders.forEach(placeholder => {
          loadAdScripts(placeholder);
        });
      }, 1000);
    }
  }
  
  /**
   * 広告スクリプトの動的ロード
   */
  function loadAdScripts(adElement) {
    // スクリプトがまだロードされていない場合のみ処理
    if (adElement.dataset.loaded) return;
    
    const scripts = adElement.querySelectorAll('script[src]');
    scripts.forEach(script => {
      const newScript = document.createElement('script');
      Array.from(script.attributes).forEach(attr => {
        newScript.setAttribute(attr.name, attr.value);
      });
      document.body.appendChild(newScript);
    });
    
    adElement.dataset.loaded = 'true';
  }
  
  // グローバル関数のエクスポート
  window.removeFile = function(index) {
    console.warn('removeFile関数は廃止されました。新しい実装を使用してください。');
  };
  
})();